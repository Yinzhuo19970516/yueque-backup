# å¾®ä¿¡å°ç¨‹åºåº•å±‚æ¡†æ¶å®ç°åŸç† è¯¾ç¨‹ç¬”è®°
## å‰è¨€

æœ€è¿‘åœ¨æ˜é‡‘ä¸Šå­¦ä¹ äº†ä¸€æœ¬å°å†Œâ€”â€”[ã€Šå¾®ä¿¡å°ç¨‹åºåº•å±‚æ¡†æ¶å®ç°åŸç†ã€‹](https://juejin.cn/book/6982013809212784676)ï¼ŒåŠ ä¸Šä»¥å‰åšå¾®ä¿¡å°ç¨‹åºçš„ç»éªŒï¼Œç»“åˆè‡ªå·±çš„å·¥ä½œç»å†ï¼Œæ·±æœ‰æ„Ÿè§¦ï¼Œå€Ÿæ­¤æœºä¼šå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹å­¦ä¹ å·¥ä½œå¿ƒå¾—ã€‚  
** 2017 å¹´ 1 æœˆå¾®ä¿¡å°ç¨‹åºæ­£å¼å‘å¸ƒã€‚**  
æˆ‘ä» 2018 å¹´æ¥è§¦å­¦ä¹ å‰ç«¯æ—¶ï¼Œæ›¾ä»¿å†™è¿‡ä¸€ä¸ªæ€§æ ¼è¯„æµ‹ç±»å°ç¨‹åº demoï¼Œåæ¥å®ä¹ æœŸé—´ï¼Œå®Œæˆäº†éƒ¨é—¨é¦–ä¸ªçœŸæ­£æ„ä¹‰ä¸Šå°ç¨‹åºã€‚åšæ¯•ä¸šè®¾è®¡æ—¶ï¼Œç»“åˆå¾®ä¿¡å°ç¨‹åºäº‘å¼€å‘èƒ½åŠ›ï¼Œåšäº†ä¸€ä¸ªé—®ç­”å°ç¨‹åºï¼ˆç±»ä¼¼ç™¾åº¦çŸ¥é“ï¼Œ360 é—®ç­”ï¼‰ã€‚åæ¥ï¼Œåšè¿‡ä¸€ä¸ªå¤§å­¦ä¿¡æ¯èµ„è®¯ç±»å°ç¨‹åºã€‚æ­£å¼å·¥ä½œä¹‹åï¼Œåšè¿‡çš„å°ç¨‹åºå°±å¾ˆå¤šäº†ï¼Œå€Ÿæ¬¾ç±»å°ç¨‹åºï¼Œè´­ç‰©ç±»å°ç¨‹åºï¼Œæ¶ˆè´¹ç±»å°ç¨‹åºï¼Œå¯¼æµç±»å°ç¨‹åºã€‚

## å‚ä¸è¿‡çš„å°ç¨‹åºæ±‡æ€»

### ä¸ªäººé¡¹ç›®ï¼š

- æµ‹æµ‹ä½ æ˜¯ä¸‰å›½æ€é‡Œçš„è°ï¼ˆdemo çº§åˆ«ï¼Œ3 ä¸ªé¡µé¢ï¼ŒåŸç”Ÿå†™æ³•ï¼Œæœªä¸Šçº¿ï¼‰
- äº‘æ¸¸è¥¿å¸ˆ ï¼ˆæ¯•ä¸šè®¾è®¡çº§åˆ«ï¼ŒåŸç”Ÿå†™æ³•ï¼Œçº¯å‰ç«¯ï¼Œå·²ä¸Šçº¿ï¼‰
- ä½ é—®æˆ‘ç­”ï¼ˆæ¯•ä¸šè®¾è®¡çº§åˆ«ï¼ŒåŸç”Ÿå†™æ³•ï¼Œäº‘å¼€å‘ï¼Œä¸ªäººè´¦å·èµ„è´¨å—é™æ— æ³•ä¸Šçº¿ï¼‰

### ä¼ä¸šé¡¹ç›®

- é”¦é²¤å¤§ä¾ ï¼ˆè¿è¥ç±»å°ç¨‹åºï¼ŒåŸç”Ÿå¼€å‘ï¼Œä¸Šçº¿ï¼Œå·²æ— æ³•å‘ç‰ˆï¼‰
- å°èµ¢è”ç›Ÿ(è´­ç‰©åˆ†ä½£ç±»å°ç¨‹åºï¼Œuni-appï¼Œä¸Šçº¿ï¼Œæ¨å¹¿æ•ˆæœä¸ä½³)
- å°èµ¢å¡è´·å€Ÿæ¬¾ï¼ˆå€Ÿæ¬¾ç±»å°ç¨‹åºï¼Œmp-vue/uni-appï¼Œæˆé•¿ä¸­ï¼‰
- åˆ·æˆ‘æ»´å¡ gopayï¼ˆæ¶ˆè´¹é‡‘èç±»å°ç¨‹åºï¼Œuni-appï¼Œæ¨å¹¿æ•ˆæœä¸å¥½ï¼‰
- åˆ·å®Œæ»´å¡å•†æˆ·ç‰ˆï¼ˆtoB å°ç¨‹åºï¼Œuni-appï¼Œæ¨å¹¿æ•ˆæœä¸å¥½ï¼‰
- å¡è´·æé€Ÿè´·ï¼ˆå¯¼æµç±»å°ç¨‹åºï¼ŒåŸç”Ÿå†™æ³•ï¼Œäº‘å¼€å‘ï¼Œæˆé•¿ä¸­ï¼‰
- ç™¾åº¦å°ç¨‹åºï¼Œæ”¯ä»˜å®å°ç¨‹åºï¼ŒæŠ–éŸ³å°ç¨‹åºï¼ˆæ­£åœ¨å¼€å‘ä¸­ï¼Œæƒ…å†µä¸æ˜ï¼‰

## ä¸ºä»€ä¹ˆè¦æŒæ¡å°ç¨‹åº

æœ‰æ‹›è˜éœ€æ±‚ï¼Œç°åœ¨éƒ¨åˆ†å›¢é˜Ÿä¼šæœ‰ä¸“é—¨æ‹›è˜å°ç¨‹åºå¼€å‘å·¥ç¨‹å¸ˆï¼ŒtoC çš„äº§å“æ‹›è˜å‰ç«¯ä¸€èˆ¬ä¹Ÿä¼šè¦æ±‚æŒæ¡å¾®ä¿¡å°ç¨‹åºï¼Œæœ‰ç›¸å…³å°ç¨‹åºå¼€å‘ç»éªŒã€‚

### äºå¼€å‘è€…

- ç›®å‰å¼€å‘çš„é¡¹ç›®æ˜¯å°ç¨‹åº
- æƒ³è‡ªå·±ç‹¬ç«‹å¼€å‘ä¸€ä¸ªå°ç¨‹åº
- å¤šæŒæ¡ä¸€é—¨æŠ€æœ¯æ˜¯å¥½çš„

### äºä¼ä¸š

- app å¼€å‘è¿­ä»£æˆæœ¬è¾ƒé«˜ï¼Œå¯¹äºæ–°ä¸šåŠ¡å°ç¨‹åºå¯ä»¥å¿«é€Ÿè¯•é”™ï¼Œæ¢ç´¢æ¸ é“
- web ç«¯çš„ç”Ÿæ€ä¸å®Œæ•´ï¼Œæ”¶ç›Šå°ï¼ˆæ¸¸æˆï¼ŒæŠ–éŸ³å°ç¨‹åºï¼Œè™ç‰™å°ç¨‹åºï¼Œæ”¯ä»˜å®å°ç¨‹åºï¼‰

## åŒçº¿ç¨‹æ¶æ„

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661780746554-7b6d83d9-a89e-4fbf-b53d-c503695f2d2c.png#averageHue=%23eaeaf2&clientId=ue7a3c520-d71a-4&from=paste&height=714&id=u9b1b8e52&name=image.png&originHeight=714&originWidth=1056&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61977&status=done&style=none&taskId=u3331bb6b-9888-40c8-895e-46060a7c41f&title=&width=1056)  
å°ç¨‹åºä¸ä¼ ç»Ÿ web å•çº¿ç¨‹æ¶æ„ç›¸æ¯”ï¼Œæ˜¯**åŒçº¿ç¨‹æ¶æ„**ã€‚  
æ¸²æŸ“å±‚å’Œé€»è¾‘å±‚ç”±ä¸¤ä¸ªçº¿ç¨‹ç®¡ç†ï¼Œé€»è¾‘å±‚é‡‡ç”¨ JSCore è¿è¡Œ js ä»£ç ï¼Œæ¸²æŸ“å±‚ä½¿ç”¨ webview è¿›è¡Œæ¸²æŸ“ã€‚å°ç¨‹åºæœ‰å¤šä¸ªé¡µé¢ï¼Œæ‰€ä»¥æ¸²æŸ“å±‚å­˜åœ¨å¤šä¸ª webviewã€‚  
ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´ç”± Native å±‚ä¹‹é—´ç»Ÿä¸€å¤„ç†ï¼Œæ— è®ºæ˜¯çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œè¿˜æ˜¯æ•°æ®çš„ä¼ é€’ï¼Œç½‘ç»œè¯·æ±‚éƒ½æ˜¯ç”± Native å±‚åšè½¬å‘ã€‚

> æ­¤å¤„æåˆ°çš„å°ç¨‹åºéƒ½ç‰¹æŒ‡å¾®ä¿¡å°ç¨‹åº

### æ¸²æŸ“ä¸€ä¸ª hello world é¡µé¢

```javascript
// index.wxml
<view>{{ msg }}</view>;

// index.js
Page({
  onLoad: function () {
    this.setData({ msg: "Hello World" });
  },
});
```

- æ¸²æŸ“å±‚å’Œæ•°æ®ç›¸å…³ã€‚
- é€»è¾‘å±‚è´Ÿè´£äº§ç”Ÿã€å¤„ç†æ•°æ®ã€‚
- é€»è¾‘å±‚é€šè¿‡ Page å®ä¾‹çš„ setData æ–¹æ³•ä¼ é€’æ•°æ®åˆ°æ¸²æŸ“å±‚ã€‚

### æ•°æ®é©±åŠ¨

WXML å¯ä»¥å…ˆè½¬æˆ JS å¯¹è±¡ï¼Œç„¶åå†æ¸²æŸ“å‡ºçœŸæ­£çš„ Dom æ ‘ï¼Œå›åˆ°â€œHello Worldâ€é‚£ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è½¬æ¢çš„è¿‡ç¨‹  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662019190737-638bb009-f458-49a4-b5de-a268232a9f5e.png#averageHue=%23fcfcfc&clientId=u8a9822a9-85c1-4&from=paste&height=285&id=u577202c6&name=image.png&originHeight=492&originWidth=1178&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39720&status=done&style=none&taskId=uc963ce9b-9955-42a5-9ff3-65478c2fcdc&title=&width=683)  
é€šè¿‡ setData æŠŠ msg æ•°æ®ä»â€œHello Worldâ€å˜æˆâ€œGoodbyeâ€ï¼Œäº§ç”Ÿçš„ JS å¯¹è±¡å¯¹åº”çš„èŠ‚ç‚¹å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶å¯ä»¥å¯¹æ¯”å‰åä¸¤ä¸ª JS å¯¹è±¡å¾—åˆ°å˜åŒ–çš„éƒ¨åˆ†ï¼Œç„¶åæŠŠè¿™ä¸ªå·®å¼‚åº”ç”¨åˆ°åŸæ¥çš„ Dom æ ‘ä¸Šï¼Œä»è€Œè¾¾åˆ°æ›´æ–° UI çš„ç›®çš„ï¼Œè¿™å°±æ˜¯â€œ**æ•°æ®é©±åŠ¨**â€ã€‚

> è¿™ä¸€ç‚¹å’Œ vue å…¶å®æ˜¯ä¸€è‡´çš„

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662019296668-7d8746e3-fe36-4f0f-aae5-87e16fd75045.png#averageHue=%23fcfcfc&clientId=u8a9822a9-85c1-4&from=paste&height=437&id=ubbd9f105&name=image.png&originHeight=873&originWidth=1178&originalType=binary&ratio=1&rotation=0&showTitle=false&size=71762&status=done&style=none&taskId=u9770ddcf-a9da-43cd-9464-d887d9bca85&title=&width=589)  
æ—¢ç„¶å°ç¨‹åºæ˜¯åŸºäºåŒçº¿ç¨‹æ¨¡å‹ï¼Œé‚£å°±æ„å‘³ç€ä»»ä½•æ•°æ®ä¼ é€’éƒ½æ˜¯çº¿ç¨‹é—´çš„é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯éƒ½ä¼šæœ‰ä¸€å®šçš„å»¶æ—¶ã€‚  
**ä¸€åˆ‡éƒ½æ˜¯å¼‚æ­¥ã€‚**

## å¿«é€Ÿæ¸²æŸ“è®¾è®¡åŸç†

å°ç¨‹åºé‡‡ç”¨å¤šä¸ª webview æ¸²æŸ“ï¼Œæ›´åŠ æ¥è¿‘åŸç”Ÿ App çš„ç”¨æˆ·ä½“éªŒã€‚  
å¦‚æœä¸ºå•é¡µé¢åº”ç”¨ï¼Œå•ç‹¬æ‰“å¼€ä¸€ä¸ªé¡µé¢ï¼Œéœ€è¦å…ˆå¸è½½å½“å‰é¡µé¢ç»“æ„ï¼Œå¹¶é‡æ–°æ¸²æŸ“ã€‚  
å¤šé¡µé¢åº”ç”¨ï¼Œæ–°é¡µé¢ç›´æ¥æ»‘åŠ¨å‡ºæ¥å¹¶ä¸”è¦†ç›–åœ¨æ—§é¡µé¢ä¸Šå³å¯ã€‚è¿™æ ·ç”¨æˆ·ä½“éªŒéå¸¸å¥½ã€‚

### æ•°é‡é™åˆ¶

é¡µé¢å¾—è½½å…¥æ˜¯é€šè¿‡åˆ›å»ºå¹¶æ’å…¥ webview æ¥å®ç°çš„ã€‚  
å¾®ä¿¡å°ç¨‹åºåšäº†é™åˆ¶ï¼Œåœ¨å¾®ä¿¡å°ç¨‹åºä¸­æ‰“å¼€çš„é¡µé¢ä¸èƒ½è¶…è¿‡ 10 ä¸ªï¼Œè¾¾åˆ° 10 ä¸ªé¡µé¢åï¼Œå°±ä¸èƒ½å†æ‰“å¼€æ–°çš„é¡µé¢ã€‚  
**æ‰€ä»¥æˆ‘ä»¬åœ¨å¼€å‘ä¸­ï¼Œè¦é¿å…è·¯ç”±åµŒå¥—å¤ªæ·±ã€‚**

### PageFrame

æˆ‘ä»¬åœ¨å†™å°ç¨‹åºé¡µé¢æ—¶ï¼Œå¹¶ä¸å…³å¿ƒ webviewï¼Œåªéœ€è¦å†™é¡µé¢ ui å’Œé€»è¾‘å³å¯ã€‚  
æˆ‘ä»¬é€šè¿‡è°ƒè¯•**å¾®ä¿¡å¼€å‘å·¥å…·**ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸¤ä¸ª webviewã€‚  
ä¸€ä¸ªåŠ è½½çš„çš„æ˜¯å½“å‰é¡µé¢ï¼ŒåŠ è½½åœ°å€å’Œå½“å‰é¡µé¢è·¯å¾„ä¸€è‡´ã€‚  
ä¸€ä¸ªæ˜¯ instanceframe.htmlã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661784066436-c79da6b3-a429-420c-add6-055fe35de298.png#clientId=ue7a3c520-d71a-4&from=paste&height=203&id=u806ead2a&name=image.png&originHeight=203&originWidth=804&originalType=binary&ratio=1&rotation=0&showTitle=false&size=96029&status=done&style=none&taskId=udb6ca8e2-c1fe-43be-ba99-867e7beef2b&title=&width=804)  
å¾®ä¿¡å°ç¨‹åºåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé™¤äº†æ¸²æŸ“é¦–é¡µä¹‹åï¼Œä¼šå¸®æˆ‘ä»¬æå‰é¢å¤–çš„é¢„åŠ è½½ä¸€ä¸ª webview,å¾®ä¿¡èµ·åä¸º instanceframe.htmlï¼Œç”¨æ¥æ–°æ¸²æŸ“ webview çš„æ¨¡æ¿ã€‚  
æˆ‘ä»¬é€šè¿‡å¾®ä¿¡å¼€å‘è€…å·¥å…·æ‰“å¼€è°ƒè¯•ï¼Œæ‰“å¼€è¿™ä¸ª instanceframe.html

```javascript
document.getElementsByTagName("webview")[1].showDevTools(true, null);
```

ä¸‹å›¾æ˜¯ pageframe/instanceframe.html çš„æ¨¡æ¿  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661843564462-3e1526ec-c87f-4994-9de4-b84a4ef923cc.png#clientId=u9d904e46-df64-4&from=paste&height=482&id=u73b50055&name=image.png&originHeight=737&originWidth=1245&originalType=binary&ratio=1&rotation=0&showTitle=false&size=295200&status=done&style=none&taskId=uc553adad-585f-48e5-8fcc-21b7b439367&title=&width=814.5)

### pageFrame çš„ html ç»“æ„ä¸­æ³¨å…¥çš„ js èµ„æº

- ./**dev**/wxconfig.js

å°ç¨‹åºé»˜è®¤æ€»é…ç½®é¡¹ï¼ŒåŒ…æ‹¬ç”¨æˆ·è‡ªå®šä¹‰ä¸ç³»ç»Ÿé»˜è®¤çš„æ•´åˆç»“æœã€‚åœ¨æ§åˆ¶å°è¾“å…¥\_\_wxConfig å¯ä»¥çœ‹å‡ºæ‰“å°ç»“æœ  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661844369150-cf8a7442-4b0f-4f1f-bf82-17e59d8b2b4e.png#clientId=u2581d3c1-f0f8-4&from=paste&height=670&id=ue2dff069&name=image.png&originHeight=846&originWidth=819&originalType=binary&ratio=1&rotation=0&showTitle=false&size=262313&status=done&style=none&taskId=u26dbfc07-ee87-4fa4-94ff-3a591283de4&title=&width=648.5)

- ./**dev**/devtoolsconfig.js

å°ç¨‹åºå¼€å‘è€…é…ç½®ï¼ŒåŒ…æ‹¬ navigationBarHeight,æ ‡é¢˜æ çš„é«˜åº¦ï¼ŒçŠ¶æ€æ é«˜åº¦ï¼Œç­‰ç­‰ï¼Œæ§åˆ¶å°è¾“å…¥\_\_devtoolsconfig å¯ä»¥çœ‹åˆ°å…¶å¯¹åº”çš„ä¿¡æ¯  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661844554563-c6130e26-fbbb-4e10-a690-0034d88e45ea.png#clientId=u2581d3c1-f0f8-4&from=paste&height=66&id=ua7dd0a62&name=image.png&originHeight=131&originWidth=693&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44431&status=done&style=none&taskId=u505ce585-e101-42fa-89fd-abf4bd0a688&title=&width=346.5)

- ./**dev**/deviceinfo.js

è®¾å¤‡ä¿¡æ¯ï¼ŒåŒ…å«å°ºå¯¸/åƒç´ ç‚¹ pixelRatio

- **dev**/jsdebug.js

debug å·¥å…·

- ./**dev**/WAWebview.js

æ¸²æŸ“å±‚åº•å±‚åŸºç¡€åº“

- ./**dev**/hls.js

ä¼˜ç§€çš„è§†é¢‘æµå¤„ç†å·¥å…·

- ./**dev**/WARemoteDebug.js

åº•å±‚åŸºç¡€åº“è°ƒè¯•å·¥å…·

- <!-- wxappcode -->

æ³¨é‡Šå ä½ç¬¦ï¼Œ æ•´ä¸ªé¡µé¢çš„ json wxss wxml ç¼–è¯‘ä¹‹åéƒ½å­˜å‚¨åœ¨è¿™é‡Œï¼Œå½“å‰æ˜¯ä¸€ä¸ªé¢„è®¾çš„ html æ¨¡ç‰ˆï¼Œæ‰€ä»¥æ˜¯ç©ºçš„

### wxappcode.js

æˆ‘ä»¬æŒ‰åŒæ ·çš„è°ƒè¯•æ–¹æ³•ï¼Œå»æ‰¾åˆ°é¦–é¡µçš„ wxappcode.js ç»“æ„ï¼Œç®€å•è¯´æ˜ä¸‹

```javascript
var decodeJsonPathName = decodeURI("pages/index/index");
__wxAppCode__[decodeJsonPathName + ".json"] = { usingComponents: {} };
var decodeWxmlPathName = decodeURI("pages/index/index");
__wxAppCode__[decodeWxmlPathName + ".wxml"] = $gwx(
  "./" + decodeWxmlPathName + ".wxml"
);
var decodeWxssPathName = decodeURI("pages/index/index");
__wxAppCode__[decodeWxssPathName + ".wxss"] = (
  window.eval || __global.__hackEval
)(
  "setCssToHead([\x22.\x22,[1],\x22test{ height: calc(\x22,[0,100],\x22-2px); ;wxcs_style_height : calc(100rpx-2px); width: \x22,[0,200],\x22; ;wxcs_style_width : 200rpx; ;wxcs_originclass: .test;;wxcs_fileinfo: ./pages/index/index.wxss 2 1; }\\n\x22,],undefined,{path:\x22./pages/index/index.wxss\x22})"
);
window.__mainPageFrameReady__ && window.__mainPageFrameReady__();
```

æ–‡ä»¶åŒ…å«äº†æ‰€æœ‰æ–‡ä»¶çš„ç¼–è¯‘è·¯å¾„  
ä¸»è¦å‡ ä¸ªé‡è¦çš„å‡½æ•°å’Œå±æ€§æœ‰

- decodeJsonPathName
- .json é…ç½®
- .wxml ç¼–è¯‘åçš„$gwx å‡½æ•°ã€‚
- .wxss ç¼–è¯‘åçš„ eval å‡½æ•°ã€‚

åä¸¤ä¸ªå‡½æ•°æˆ‘ä»¬ä¼šåœ¨åæ–‡å±•å¼€åˆ†æã€‚  
**å½“å°ç¨‹åºéœ€è¦æ‰“å¼€æŸä¸ªé¡µé¢çš„æ—¶å€™ï¼Œåªéœ€è¦æå–é¡µé¢çš„è€…å‡ ä¸ªå±æ€§ï¼Œæ³¨å…¥åˆ°é¢„åŠ è½½çš„ html æ¨¡ç‰ˆä¸­å°±å¯ä»¥å¿«é€Ÿç”Ÿæˆä¸€ä¸ªæ–°çš„ webview**

### å¿«é€Ÿå¯åŠ¨

åœ¨è§†å›¾å±‚å†…ï¼Œæ¯ä¸ªé¡µé¢éƒ½æ˜¯ä¸€ä¸ª webiewï¼Œå½“å°ç¨‹åºå¯åŠ¨æ—¶åªæœ‰é¦–é¡µä¸€ä¸ª webview  
æ‰§è¡Œ wx.navigateTo æ–°å¼€ä¸€ä¸ªé¡µé¢çš„æ—¶å€™ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ webview å¹¶æ’å…¥åˆ°è§†å›¾å±‚  
wx.navigateBack åˆ™ä¸ºé”€æ¯ webview  
å°ç¨‹åºæ¯ä¸ªè§†å›¾å±‚é¡µé¢å†…å®¹éƒ½æ˜¯é€šè¿‡ pageframe.html æ¨¡æ¿æ¥ç”Ÿæˆçš„ã€‚

- é¦–é¡µå¯åŠ¨æ—¶ï¼Œå³ç¬¬ä¸€æ¬¡é€šè¿‡ pageframe.html ç”Ÿæˆå†…å®¹åï¼Œåå°æœåŠ¡ä¼šç¼“å­˜ pageframe.html æ¨¡æ¿é¦–æ¬¡ç”Ÿæˆçš„ html å†…å®¹
- éé¦–æ¬¡æ–°æ‰“å¼€é¡µé¢æ—¶ï¼Œé¡µé¢è¯·æ±‚çš„ pageframe.html å†…å®¹ç›´æ¥èµ°åå°ç¼“å­˜
- éé¦–æ¬¡æ–°æ‰“å¼€é¡µé¢æ—¶ï¼Œpageframe.html é¡µé¢å¼•å…¥çš„å¤–é“¾ js èµ„æºèµ°æœ¬åœ°ç¼“å­˜

è¿™æ ·åœ¨åç»­æ–°æ‰“å¼€é¡µé¢æ—¶ï¼Œéƒ½ä¼šèµ°ç¼“å­˜çš„ pageframe çš„å†…å®¹ï¼Œé¿å…é‡å¤ç”Ÿæˆï¼Œå¿«é€Ÿæ‰“å¼€ä¸€ä¸ªæ–°é¡µé¢ã€‚

### é¦–æ¬¡æ‰“å¼€æ–°é¡µé¢

- å¯åŠ¨ä¸€ä¸ª webviewï¼Œsrc ä¸ºç©ºåœ°å€http://127.0.0.1:${global.proxyPort}/aboutblank?${c}
- webview åˆå§‹åŒ–å®Œæ¯•åï¼Œè®¾ç½®åœ°å€ src ä¸º pageframe.htmlï¼Œå¼€å§‹åŠ è½½æ³¨å…¥çš„é¢„è®¾æ ·å¼å’Œé¢„è®¾ js ä»£ç 
- pageframe.html åœ¨ dom ready ä¹‹åï¼Œè§¦å‘æ³¨å…¥å¹¶æ‰§è¡Œå…·ä½“é¡µé¢çš„ç›¸å…³ä»£ç 

ä¸‹å›¾ä»£ç ä¸­å¯ä»¥çœ‹åˆ° dom åŠ è½½å®Œæ¯•ä¹‹åï¼Œè§¦å‘ alert é€šçŸ¥  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661848819791-b9239654-a402-48fe-b9b1-6b84ce2e0e9c.png#clientId=u2581d3c1-f0f8-4&from=paste&height=406&id=ue213ea47&name=image.png&originHeight=388&originWidth=604&originalType=binary&ratio=1&rotation=0&showTitle=false&size=66116&status=done&style=none&taskId=u14edca52-2e0a-4923-b206-b480ad6bc7e&title=&width=632)

- æ­¤æ—¶é€šè¿‡ history.pushState æ–¹æ³•ä¿®æ”¹ webview çš„ src ä½†æ˜¯ webview å¹¶ä¸ä¼šå‘é€é¡µé¢è¯·æ±‚ã€‚
- å› æ­¤ webview è·¯å¾„å˜åŒ–ä¸º
  - http://127.0.0.1:${global.proxyPort}/aboutblank?${c}
  - http://127.0.0.1::63444/__pageframe__/instanceframe.html
  - http://127.0.0.1:63444/__pageframe__/pages/index/index
- æ­£å¥½å¯¹åº” webview åŠ è½½è¿‡ç¨‹

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661848518051-a8ce446d-afa6-4a1c-9051-a52d8bd41516.png#clientId=u2581d3c1-f0f8-4&from=paste&height=558&id=ud3f9846d&name=image.png&originHeight=670&originWidth=898&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100214&status=done&style=none&taskId=ue9cbdac2-e798-4065-94eb-b4d02917ceb&title=&width=748)

## wxml è®¾è®¡æ€è·¯

ç½‘é¡µç¼–ç¨‹ä¸€èˆ¬é‡‡ç”¨çš„æ˜¯ HTML + CSS + JS çš„ç»„åˆï¼Œå…¶ä¸­ HTML æ˜¯ç”¨æ¥æè¿°å½“å‰è¿™ä¸ªé¡µé¢çš„ç»“æ„ï¼ŒCSS ç”¨æ¥æè¿°é¡µé¢çš„æ ·å­ï¼ŒJS é€šå¸¸æ˜¯ç”¨æ¥å¤„ç†è¿™ä¸ªé¡µé¢å’Œç”¨æˆ·çš„äº¤äº’ã€‚  
åŒæ ·é“ç†ï¼Œåœ¨å°ç¨‹åºä¸­ä¹Ÿæœ‰åŒæ ·çš„è§’è‰²ï¼Œå…¶ä¸­ WXML å……å½“çš„å°±æ˜¯ç±»ä¼¼ HTML çš„è§’è‰²ã€‚  
å°ç¨‹åºè‡ªè¡Œæ­å»ºäº†ç»„ä»¶ç»„ç»‡æ¡†æ¶ Exparser æ¡†æ¶  
**Exparser çš„ç»„ä»¶æ¨¡å‹ä¸ WebComponents æ ‡å‡†ä¸­çš„ ShadowDOM é«˜åº¦ç›¸ä¼¼**  
å¦‚ä¸‹ä»£ç ï¼Œæˆ‘ä»¬å®šä¹‰åœ¨ wxml ä¸­

```html
<!--index.wxml-->
<view class="container">
  Weixin
  <text style="position:relative;">æ–‡æœ¬</text>
</view>
<button bindtap="test">æŒ‰é’®</button>
```

Exparser æ¡†æ¶ä¼šå°†ä¸Šè¿°ç»“æ„è½¬æ¢ä¸ºä¸‹é¢è¿™ä¸ªæ ·å­

```html
<wx-view
  exparser:info-class-prefix=""
  exparser:info-component-id="2"
  class="container"
>
  Weixin
  <wx-text
    exparser:info-class-prefix=""
    exparser:info-component-id="3"
    style="position:relative;"
  >
    <span style="display:none;">æ–‡æœ¬</span>
    <span>æ–‡æœ¬</span></wx-text
  >
</wx-view>
<wx-button
  exparser:info-class-prefix=""
  exparser:info-component-id="4"
  exparser:info-attr-bindtap="test"
  role="button"
  aria-disabled="false"
>
  æŒ‰é’®
</wx-button>
```

è¿™æ ·çœ‹çš„è¯æ˜¯ä¸æ˜¯å’Œ WebComponents ä¸€æ ·äº†ï¼Œä½†æ˜¯å°ç¨‹åºå¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨ WebComponentsï¼Œè€Œæ˜¯è‡ªè¡Œæ­å»ºäº†ç»„ä»¶æ¡†æ¶ Exparserã€‚

### WebComponents

Web Components æ˜¯ä¸€ä¸ªæµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„ç»„ä»¶åŒ–æ–¹æ¡ˆï¼Œå…è®¸ä½ åˆ›å»ºæ–°çš„è‡ªå®šä¹‰ã€å¯å°è£…ã€å¯é‡ç”¨çš„ HTML æ ‡è®°ã€‚ä¸ç”¨åŠ è½½ä»»ä½•å¤–éƒ¨æ¨¡å—ï¼Œç›´æ¥å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è·‘ã€‚  
å¦‚ä¸‹ä»£ç ï¼Œ<custom-component>æ ‡ç­¾å°±æ˜¯è‡ªå®šä¹‰ç»„ä»¶çš„æ ‡ç­¾äº†ï¼Œå®ƒä¸å±äº html è¯­ä¹‰åŒ–æ ‡ç­¾ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œæ˜¯è‡ªå®šä¹‰çš„ã€‚

```html
<html>
  <head> </head>
  <body>
    <user-card></user-card>
    <template id="userCardId">
      <!--ç»„ä»¶çš„æ ·å¼ä¸ä»£ç å°è£…åœ¨ä¸€èµ·ï¼Œåªå¯¹è‡ªå®šä¹‰å…ƒç´ ç”Ÿæ•ˆï¼Œä¸ä¼šå½±å“å¤–éƒ¨çš„å…¨å±€æ ·å¼ã€‚-->
      <style>
        .name {
          color: red;
          font-size: 50px;
        }
        button {
          width: 200px;
        }
      </style>
      <p class="name">21312</p>
      <button>test</button>
    </template>
    <script>
      class UserCard extends HTMLElement {
        constructor() {
          super();
          var shadow = this.attachShadow({ mode: "closed" });

          var templateElem = document.getElementById("userCardId");
          var content = templateElem.content.cloneNode(true);

          // this.appendChild(content)
          shadow.appendChild(content);
        }
      }

      window.customElements.define("user-card", UserCard);
    </script>
  </body>
</html>
```

WebComponent ä¸»è¦å°±æ˜¯ä¸‰ä¸ªè§„èŒƒï¼š

- **Custom Elements è§„èŒƒ**

å¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ ‡ç­¾ã€‚æ ¹æ®è§„èŒƒï¼Œè‡ªå®šä¹‰å…ƒç´ çš„åç§°å¿…é¡»åŒ…å«è¿è¯çº¿â€-â€œï¼Œç”¨ä¸åŒºåˆ«åŸç”Ÿçš„ HTML å…ƒç´ ã€‚  
å¯ä»¥æŒ‡å®šå¤šä¸ªä¸åŒçš„å›è°ƒå‡½æ•°ï¼Œå®ƒä»¬å°†ä¼šåœ¨å…ƒç´ çš„ä¸åŒç”Ÿå‘½æ—¶æœŸè¢«è°ƒç”¨ã€‚

- **templates è§„èŒƒ **

  æä¾›äº†<template>æ ‡ç­¾ï¼Œå¯ä»¥åœ¨å®ƒé‡Œé¢ä½¿ç”¨ HTML å®šä¹‰ DOM ç»“æ„ã€‚

- **Shadow DOM è§„èŒƒ**

ä¸‹å›¾ä¸­ï¼Œçœ‹ä¸€ä¸‹å³ä¾§çš„ HTML ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å±•å¼€<user-card>æ ‡è®°çœ‹åˆ°é‡Œé¢çš„ç»“æ„ã€‚æ˜¯ä¸æ˜¯æœ‰ç§ç™½å°è£…äº†çš„æ„Ÿè§‰ã€‚å¦‚æœåªæœ‰è¿™æ ·çš„æ•ˆæœçš„è¯ï¼Œè·Ÿæ¨¡æ¿å¼•æ“æ¸²æŸ“ç»„ä»¶çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿçœ‹åˆ°<user-card>çš„å†…éƒ¨ä»£ç ï¼ŒWebComponent å…è®¸å†…éƒ¨ä»£ç éšè—èµ·æ¥ï¼Œè¿™å«åš Shadow DOMï¼Œå³è¿™éƒ¨åˆ† DOM é»˜è®¤ä¸å¤–éƒ¨ DOM éš”ç¦»ï¼Œå†…éƒ¨ä»»ä½•ä»£ç éƒ½æ— æ³•å½±å“å¤–éƒ¨ã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662017146016-0f71cfea-c195-40b1-a1be-0ac9f3b2279e.png#clientId=u8a9822a9-85c1-4&from=paste&height=271&id=u0b71a97a&name=image.png&originHeight=541&originWidth=1352&originalType=binary&ratio=1&rotation=0&showTitle=false&size=231700&status=done&style=none&taskId=u177d2794-49ac-4661-89a6-ca29391da05&title=&width=676)

### ShadowDOM

é¦–å…ˆå®ä¾‹åŒ–ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼ŒæŒ‚è½½åˆ°å®¿ä¸»ä¸Šï¼Œè¿™é‡Œçš„å®¿ä¸»æ˜¯ thisã€‚ä¸Šé¢è¯´è¿‡ï¼Œthis æŒ‡å‘ user-cardã€‚  
ç„¶åæˆ‘ä»¬æŠŠåˆ›å»ºçš„ DOM ç»“æ„ï¼Œæˆ–è€…<template>ç»“æ„æŒ‚è½½åˆ°å½±å­æ ¹ä¸Šå³å¯ã€‚çœ‹ä¸€ä¸‹ HTML ç»“æ„å±•ç¤ºã€‚

```javascript
var shadow = this.attachShadow({ mode: "closed" });
shadow.appendChild(content);
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662017234194-4b4ca104-d43e-4ebc-81b4-86dca1a13a21.png#clientId=u8a9822a9-85c1-4&from=paste&height=306&id=rZWJb&name=image.png&originHeight=612&originWidth=1328&originalType=binary&ratio=1&rotation=0&showTitle=false&size=220190&status=done&style=none&taskId=uddaa4137-9158-4f08-81f7-4307c7bd3ae&title=&width=664)  
å†…ç½®çš„æ§ä»¶å…ƒç´ ä¸èƒ½æˆä¸ºå®¿ä¸»ï¼Œæ¯”å¦‚ï¼šimgã€buttonã€inputã€textareaã€selectã€radioã€checkboxï¼Œvideo ç­‰ç­‰ï¼Œå› ä¸ºä»–ä»¬å·²ç»æ˜¯ #shadow-root  
å¦‚æœæ„¿æ„çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒè¯•ä»–ä»¬çš„ shadowï¼Œçœ‹çœ‹è¿™äº›æ ‡ç­¾çš„çœŸå®ç»“æ„  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662017597039-15ef7999-d45f-4034-bb58-c42caa828a48.png#clientId=u8a9822a9-85c1-4&from=paste&height=443&id=udf41ef71&name=image.png&originHeight=886&originWidth=921&originalType=binary&ratio=1&rotation=0&showTitle=false&size=333806&status=done&style=none&taskId=u4ec3b98c-77e5-4a16-af70-a452b0aadfe&title=&width=460.5)

### Exparser æ¡†æ¶åŸç†

Exparser æ˜¯å¾®ä¿¡å°ç¨‹åºçš„ç»„ä»¶ç»„ç»‡æ¡†æ¶ï¼Œå†…ç½®åœ¨å°ç¨‹åºåŸºç¡€åº“ä¸­ï¼Œä¸ºå°ç¨‹åºæä¾›å„ç§å„æ ·çš„ç»„ä»¶æ”¯æ’‘ã€‚  
å†…ç½®ç»„ä»¶å’Œè‡ªå®šä¹‰ç»„ä»¶éƒ½æœ‰ Exparser ç»„ç»‡ç®¡ç†ã€‚  
Exparser çš„ç»„ä»¶æ¨¡å‹ä¸ WebComponents æ ‡å‡†ä¸­çš„ Shadow DOM é«˜åº¦ç›¸ä¼¼ã€‚  
Exparser ä¼šç»´æŠ¤æ•´ä¸ªé¡µé¢çš„èŠ‚ç‚¹æ ‘ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹çš„å±æ€§ã€äº‹ä»¶ç»‘å®šç­‰ï¼Œç›¸å½“äºä¸€ä¸ªç®€åŒ–ç‰ˆçš„ Shadow DOM å®ç°ã€‚Exparser çš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š

- **åŸºäº Shadow DOM æ¨¡å‹**ï¼šæ¨¡å‹ä¸Šä¸ WebComponents çš„ ShadowDOM é«˜åº¦ç›¸ä¼¼ï¼Œä½†ä¸ä¾èµ–æµè§ˆå™¨çš„åŸç”Ÿæ”¯æŒï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–ä¾èµ–åº“ï¼›å®ç°æ—¶ï¼Œè¿˜é’ˆå¯¹æ€§åœ°å¢åŠ äº†å…¶ä»– API ä»¥æ”¯æŒå°ç¨‹åºç»„ä»¶ç¼–ç¨‹ã€‚
- **å¯åœ¨çº¯ JS ç¯å¢ƒä¸­è¿è¡Œ**ï¼šè¿™æ„å‘³ç€é€»è¾‘å±‚ä¹Ÿå…·æœ‰ä¸€å®šçš„ç»„ä»¶æ ‘ç»„ç»‡èƒ½åŠ›ã€‚
- **é«˜æ•ˆè½»é‡**ï¼šæ€§èƒ½è¡¨ç°å¥½ï¼Œåœ¨ç»„ä»¶å®ä¾‹æå¤šçš„ç¯å¢ƒä¸‹è¡¨ç°å°¤å…¶ä¼˜å¼‚ï¼ŒåŒæ—¶ä»£ç å°ºå¯¸ä¹Ÿè¾ƒå°ã€‚

å°ç¨‹åºä¸­ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ ‘ç›¸å…³çš„æ“ä½œéƒ½ä¾èµ–äº Exparserï¼ŒåŒ…æ‹¬ WXML åˆ°é¡µé¢æœ€ç»ˆèŠ‚ç‚¹æ ‘çš„æ„å»ºå’Œè‡ªå®šä¹‰ç»„ä»¶ç‰¹æ€§ç­‰ã€‚

### åŸç”Ÿç»„ä»¶

å°ç¨‹åºä¸­çš„éƒ¨åˆ†ç»„ä»¶æ˜¯ç”±å®¢æˆ·ç«¯åˆ›å»ºçš„åŸç”Ÿç»„ä»¶ï¼Œå¹¶ä¸å®Œå…¨åœ¨ Exparser çš„æ¸²æŸ“ä½“ç³»ä¸‹ï¼Œè¿™äº›ç»„ä»¶æœ‰ï¼š

- [camera](https://developers.weixin.qq.com/miniprogram/dev/component/camera.html)
- [canvas](https://developers.weixin.qq.com/miniprogram/dev/component/canvas.html)
- [input](https://developers.weixin.qq.com/miniprogram/dev/component/input.html)ï¼ˆä»…åœ¨ focus æ—¶è¡¨ç°ä¸ºåŸç”Ÿç»„ä»¶ï¼‰
- [live-player](https://developers.weixin.qq.com/miniprogram/dev/component/live-player.html)
- [live-pusher](https://developers.weixin.qq.com/miniprogram/dev/component/live-pusher.html)
- [map](https://developers.weixin.qq.com/miniprogram/dev/component/map.html)
- [textarea](https://developers.weixin.qq.com/miniprogram/dev/component/textarea.html)
- [video](https://developers.weixin.qq.com/miniprogram/dev/component/video.html)

å¼•å…¥åŸç”Ÿç»„ä»¶ä¸»è¦æœ‰ 3 ä¸ªå¥½å¤„ï¼š

- **æ‰©å±• Web çš„èƒ½åŠ›**ã€‚æ¯”å¦‚åƒè¾“å…¥æ¡†ç»„ä»¶ï¼ˆinput, textareaï¼‰æœ‰æ›´å¥½åœ°æ§åˆ¶é”®ç›˜çš„èƒ½åŠ›ã€‚
- **ä½“éªŒæ›´å¥½ï¼ŒåŒæ—¶ä¹Ÿå‡è½» WebView çš„æ¸²æŸ“å·¥ä½œ**ã€‚æ¯”å¦‚åƒåœ°å›¾ç»„ä»¶ï¼ˆmapï¼‰è¿™ç±»è¾ƒå¤æ‚çš„ç»„ä»¶ï¼Œå…¶æ¸²æŸ“å·¥ä½œä¸å ç”¨ WebView çº¿ç¨‹ï¼Œè€Œäº¤ç»™æ›´é«˜æ•ˆçš„å®¢æˆ·ç«¯åŸç”Ÿå¤„ç†ã€‚
- **ç»•è¿‡ setDataã€æ•°æ®é€šä¿¡å’Œé‡æ¸²æŸ“æµç¨‹ï¼Œä½¿æ¸²æŸ“æ€§èƒ½æ›´å¥½**ã€‚æ¯”å¦‚åƒç”»å¸ƒç»„ä»¶ï¼ˆcanvasï¼‰å¯ç›´æ¥ç”¨ä¸€å¥—ä¸°å¯Œçš„ç»˜å›¾æ¥å£è¿›è¡Œç»˜åˆ¶ã€‚

### ç‰¹æ®Šåœºæ™¯

å¦‚æœä¸šåŠ¡åœºæ™¯ä¸ºæ‰‹åŠ¿è¯†åˆ«ä¹‹ç±»çš„ï¼Œç›‘å¬äº‹ä»¶ä¸æ–­çš„è§¦å‘ï¼Œæ•°æ®ä¸æ–­çš„æ”¹å˜ã€‚  
è¿™æ ·çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åƒï¼Œå¦‚æœåæ ‡å€¼ä¸æ–­æ”¹å˜çš„è¯ï¼Œåœ¨é€»è¾‘ä¸è§†å›¾åˆ†å¼€çš„åŒçº¿ç¨‹æ¶æ„ä¸­ï¼Œçº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„é€šè®¯æ˜¯éå¸¸é¢‘ç¹çš„ï¼Œä¼šæœ‰å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ã€‚  
æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾®ä¿¡å¼€æ”¾äº†ä¸€ä¸ªæ ‡è®°<WXS>ï¼Œå¯ä»¥åœ¨æ¸²æŸ“å±‚å†™éƒ¨åˆ† js é€»è¾‘ã€‚è¿™æ ·è¯å°±å¯ä»¥åœ¨æ¸²æŸ“å±‚å•ç‹¬å¤„ç†é¢‘ç¹æ”¹å˜çš„æ•°æ®ï¼Œå°±é¿å…äº†çº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´é¢‘ç¹é€šè®¯å¯¼è‡´çš„æ€§èƒ½å’Œå»¶æ—¶é—®é¢˜ã€‚

### ä¼˜åŠ¿

WXML æ¨¡ç‰ˆè¯­æ³•ç»è¿‡è½¬æ¢ä¹‹åï¼Œä¼šå·²è‡ªå®šä¹‰å…ƒç´ çš„å½¢å¼æ¥æ¸²æŸ“ã€‚è¿™é‡Œä¼šæœ‰ä¸ªç–‘é—® ğŸ¤”ï¸ï¼Œä¸ºä»€ä¹ˆä¸ç”¨ HTML è¯­æ³•å’Œ WebComponents æ¥å®ç°æ¸²æŸ“ï¼Œè€Œæ˜¯é€‰æ‹©è‡ªå®šä¹‰ï¼Ÿ

- ç®¡æ§ä¸å®‰å…¨ï¼šweb æŠ€æœ¯å¯ä»¥é€šè¿‡è„šæœ¬è·å–ä¿®æ”¹é¡µé¢æ•æ„Ÿå†…å®¹æˆ–è€…éšæ„è·³è½¬å…¶å®ƒé¡µé¢
- èƒ½åŠ›æœ‰é™ï¼šä¼šé™åˆ¶å°ç¨‹åºçš„è¡¨ç°å½¢å¼
- æ ‡ç­¾ä¼—å¤šï¼šå¢åŠ ç†è§£æˆæœ¬

## wxss è®¾è®¡æ€è·¯

WXSS å…·æœ‰ CSS çš„å¤§éƒ¨åˆ†ç‰¹æ€§ã€‚åŒæ—¶ä¸ºäº†æ›´é€‚åˆå¼€å‘å¾®ä¿¡å°ç¨‹åºï¼ŒWXSS å¯¹ CSS è¿›è¡Œäº†æ‰©å……ä»¥åŠä¿®æ”¹ã€‚é€šä¿—çš„å¯ä»¥ç†è§£æˆåŸºäº CSS æ”¹äº†ç‚¹ä¸œè¥¿ï¼ŒåˆåŠ äº†ç‚¹ä¸œè¥¿ã€‚  
ä¸ CSS ç›¸æ¯”ï¼ŒWXSS æ‰©å±•çš„ç‰¹æ€§æœ‰ï¼š

- å°ºå¯¸å•ä½

**rpxï¼ˆresponsive pixelï¼‰**: å¯ä»¥æ ¹æ®å±å¹•å®½åº¦è¿›è¡Œè‡ªé€‚åº”ã€‚è§„å®šå±å¹•å®½ä¸º 750rpxã€‚å¦‚åœ¨ iPhone6 ä¸Šï¼Œå±å¹•å®½åº¦ä¸º 375pxï¼Œå…±æœ‰ 750 ä¸ªç‰©ç†åƒç´ ï¼Œåˆ™ 750rpx = 375px = 750 ç‰©ç†åƒç´ ï¼Œ1rpx = 0.5px = 1 ç‰©ç†åƒç´ ã€‚

| **è®¾å¤‡**     | **rpx æ¢ç®— px (å±å¹•å®½åº¦/750)** | **px æ¢ç®— rpx (750/å±å¹•å®½åº¦)** |
| ------------ | ------------------------------ | ------------------------------ |
| iPhone5      | 1rpx = 0.42px                  | 1px = 2.34rpx                  |
| iPhone6      | 1rpx = 0.5px                   | 1px = 2rpx                     |
| iPhone6 Plus | 1rpx = 0.552px                 | 1px = 1.81rpx                  |

- æ ·å¼å¯¼å…¥  
  ä½¿ç”¨**@import**è¯­å¥å¯ä»¥å¯¼å…¥å¤–è”æ ·å¼è¡¨ï¼Œ**@import**åè·Ÿéœ€è¦å¯¼å…¥çš„å¤–è”æ ·å¼è¡¨çš„ç›¸å¯¹è·¯å¾„ï¼Œç”¨;è¡¨ç¤ºè¯­å¥ç»“æŸã€‚

### ç¼–è¯‘

```javascript
/**index.wxss**/
.test{
  height: calc(100rpx-2px);
  width: 200rpx;
}
```

å¦‚ä¸Šæˆ‘ä»¬å®šä¹‰çš„ index.wxssï¼Œä¼šè¢«ç¼–è¯‘æˆ jsï¼Œæ³¨å…¥ webview  
æˆ‘ä»¬æŠŠç¼–è¯‘åçš„ js åˆ†æˆä¸‰éƒ¨åˆ†ï¼Œå±•å¼€åˆ†æã€‚  
ç¬¬ä¸€éƒ¨åˆ†ç”¨äºè·å–ä¸€å¥—åŸºæœ¬è®¾å¤‡ä¿¡æ¯ï¼ŒåŒ…å«è®¾å¤‡é«˜åº¦ã€è®¾å¤‡å®½åº¦ã€ç‰©ç†åƒç´ ä¸ CSS åƒç´ æ¯”ä¾‹ã€è®¾å¤‡æ–¹å‘ã€‚

```javascript
/*********/
/*ç¬¬ä¸€éƒ¨åˆ†*/
/*è®¾å¤‡ä¿¡æ¯*/
/*********/
var BASE_DEVICE_WIDTH = 750; // åŸºç¡€è®¾å¤‡å®½åº¦750
var isIOS = navigator.userAgent.match("iPhone"); // æ˜¯å¦ipheone æœºå‹
var deviceWidth = window.screen.width || 375; // è®¾å¤‡å®½åº¦ é»˜è®¤375
var deviceDPR = window.devicePixelRatio || 2; // è·å–ç‰©ç†åƒç´ ä¸cssåƒç´ æ¯”ä¾‹ é»˜è®¤2
var checkDeviceWidth =
  window.__checkDeviceWidth__ ||
  function () {
    var newDeviceWidth = window.screen.width || 375; // åˆå§‹åŒ–è®¾å¤‡å®½åº¦
    var newDeviceDPR = window.devicePixelRatio || 2; // åˆå§‹åŒ–è®¾å¤‡ åƒç´ æ¯”ä¾‹
    var newDeviceHeight = window.screen.height || 375; // åˆå§‹åŒ–è®¾å¤‡é«˜åº¦
    // åˆ¤æ–­å±å¹•æ–¹å‘ landscape ä¸ºæ¨ªå‘ï¼Œå¦‚æœæ˜¯æ¨ªå‘ é«˜åº¦å€¼ç»™å®½åº¦
    if (
      window.screen.orientation &&
      /^landscape/.test(window.screen.orientation.type || "")
    )
      newDeviceWidth = newDeviceHeight;
    // æ›´æ–°è®¾å¤‡ä¿¡æ¯
    if (newDeviceWidth !== deviceWidth || newDeviceDPR !== deviceDPR) {
      deviceWidth = newDeviceWidth;
      deviceDPR = newDeviceDPR;
    }
  };
// æ£€æŸ¥è®¾å¤‡ä¿¡æ¯
checkDeviceWidth();
```

ç¬¬äºŒéƒ¨åˆ†ï¼šè½¬åŒ– rpx  
æ ¸å¿ƒå°±æ˜¯ï¼šä¸‹é¢ä¸¤å¥ï¼Œåšäº†ä¸€ä¸ªç²¾åº¦æ”¶æ‹¢  
**number = number / BASE_DEVICE_WIDTH \* (newDeviceWidth || deviceWidth); **  
**number = Math.floor(number + eps);**

```javascript
/*********/
/*ç¬¬äºŒéƒ¨åˆ†*/
/*è½¬åŒ–rpx*/
/*********/
var eps = 1e-4; //0.0001
var transformRPX =
  window.__transformRpx__ ||
  function (number, newDeviceWidth) {
    // å¦‚æœ0 è¿”å› 0  0rpx = 0px
    if (number === 0) return 0;
    // px = rpxå€¼ / åŸºç¡€è®¾å¤‡å®½åº¦750 * è®¾å¤‡å®½åº¦
    number = (number / BASE_DEVICE_WIDTH) * (newDeviceWidth || deviceWidth);
    // è¿”å›å°äºç­‰äº number + 0.0001çš„å¤§æ•´æ•°ï¼Œç”¨æˆ·æ”¶æ‹¢ç²¾åº¦
    number = Math.floor(number + eps);
    if (number === 0) {
      // å¦‚æœnumber == 0,è¯´æ˜è¾“å…¥ä¸º1rpx
      if (deviceDPR === 1 || !isIOS) {
        // éIOS æˆ–è€… åƒç´ æ¯”ä¸º1ï¼Œè¿”å›1
        return 1;
      } else {
        return 0.5;
      }
    }
    return number;
  };
```

ç¬¬ä¸‰éƒ¨åˆ†ä¸»è¦æ˜¯ setCssToHead é¡¾åæ€ä¹‰

```javascript
/*********/
/*ç¬¬ä¸‰éƒ¨åˆ†*/
/*setCssToHead*/
/*********/
window.__rpxRecalculatingFuncs__ = window.__rpxRecalculatingFuncs__ || [];
var __COMMON_STYLESHEETS__ = __COMMON_STYLESHEETS__ || {} % s;
var setCssToHead = function (file, _xcInvalid, info) {
  var Ca = {};
  var css_id;
  var info = info || {};
  var _C = __COMMON_STYLESHEETS__;
  function makeup(file, opt) {
    var _n = typeof file === "string";
    if (_n && Ca.hasOwnProperty(file)) return "";
    if (_n) Ca[file] = 1;
    var ex = _n ? _C[file] : file;
    var res = "";
    for (var i = ex.length - 1; i >= 0; i--) {
      var content = ex[i];
      if (typeof content === "object") {
        var op = content[0];
        if (op == 0)
          res = transformRPX(content[1], opt.deviceWidth) + "px" + res;
        else if (op == 1) res = opt.suffix + res;
        else if (op == 2) res = makeup(content[1], opt) + res;
      } else res = content + res;
    }
    return res;
  }
  var styleSheetManager = window.__styleSheetManager2__;
  var rewritor = function (suffix, opt, style) {
    opt = opt || {};
    suffix = suffix || "";
    opt.suffix = suffix;
    if (opt.allowIllegalSelector != undefined && _xcInvalid != undefined) {
      if (opt.allowIllegalSelector) console.warn("For developer:" + _xcInvalid);
      else {
        console.error(_xcInvalid);
      }
    }
    Ca = {};
    css = makeup(file, opt);
    if (styleSheetManager) {
      var key = (info.path || Math.random()) + ":" + suffix;
      if (!style) {
        styleSheetManager.addItem(key, info.path);
        window.__rpxRecalculatingFuncs__.push(function (size) {
          opt.deviceWidth = size.width;
          rewritor(suffix, opt, true);
        });
      }
      styleSheetManager.setCss(key, css);
      return;
    }
    if (!style) {
      var head = document.head || document.getElementsByTagName("head")[0];
      style = document.createElement("style");
      style.type = "text/css";
      style.setAttribute("wxss:path", info.path);
      head.appendChild(style);
      window.__rpxRecalculatingFuncs__.push(function (size) {
        opt.deviceWidth = size.width;
        rewritor(suffix, opt, style);
      });
    }
    if (style.styleSheet) {
      style.styleSheet.cssText = css;
    } else {
      if (style.childNodes.length == 0)
        style.appendChild(document.createTextNode(css));
      else style.childNodes[0].nodeValue = css;
    }
  };
  return rewritor;
};
setCssToHead([
  ".",
  [1],
  "test{ height: calc(",
  [0, 100],
  "-2px); width: ",
  [0, 200],
  "; }\n",
])(typeof __wxAppSuffixCode__ == "undefined" ? undefined : __wxAppSuffixCode__);
```

setCssToHead ä¼ çš„å‚æ•° æ˜¯æˆ‘ä»¬å®šä¹‰çš„ wxcss,å˜æˆäº†ç»“æ„åŒ–æ•°æ®ï¼Œæ–¹ä¾¿éå†å¤„ç†  
index.wxss ä¸­å†™ rpx å•ä½çš„å±æ€§éƒ½å˜æˆäº†åŒºé—´çš„æ ·å­[0, 100]ã€[0, 200]ã€‚å…¶ä»–å•ä½å¹¶æ²¡æœ‰è½¬æ¢ã€‚è¿™æ ·çš„è¯å°±å¯ä»¥æ–¹ä¾¿çš„è¯†åˆ«å“ªé‡Œå†™äº† rpx å•ä½  
**[".", [1], "test{ height: calc(", [0, 100], "-2px); width: ", [0, 200], "; }\n", ]**

### æ³¨å…¥

åœ¨æ¸²æŸ“å±‚çš„ä¸€ä¸ªçš„<script>æ ‡ç­¾ä¸­,æœ‰å¾ˆé•¿çš„ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”ç”¨ eval æ–¹æ³•æ‰§è¡Œã€‚å¦‚æœä½ ä»”ç»†çœ‹çš„è¯ï¼Œè¿˜æ˜¯å¯ä»¥å‹‰å¼ºåˆ†è¾¨å‡ºï¼Œè¿™ä¸ªå­—ç¬¦ä¸²æ­£æ˜¯æˆ‘ä»¬å‰é¢ç¼–è¯‘å‡ºæ¥çš„ js è½¬æ¢æˆçš„ã€‚  
è¿™æ ·å°±å¯ä»¥å¾—çŸ¥ï¼Œç¼–è¯‘åçš„ä»£ç æ˜¯é€šè¿‡ eval æ–¹æ³•æ³¨å…¥æ‰§è¡Œçš„ã€‚è¿™æ ·çš„è¯å®Œæˆäº† WXSS çš„ä¸€æ•´å¥—æµç¨‹ã€‚  
**åŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯åœ¨ä¿®æ”¹ pageFrame çš„è·¯å¾„ä¹‹åï¼Œåˆå§‹åŒ–å°ç¨‹åºæ ·å¼é…ç½®æ–‡ä»¶ä¹‹åï¼Œæ‰å¼€å§‹æ³¨å…¥æ ·å¼æ–‡ä»¶**  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661850771462-e8b5a526-8cfc-425c-84e3-268894dd32c3.png#clientId=u8eecab90-4676-4&from=paste&height=475&id=uf879ca6e&name=image.png&originHeight=608&originWidth=940&originalType=binary&ratio=1&rotation=0&showTitle=false&size=296219&status=done&style=none&taskId=u1c1839ec-cf6f-4e64-b8bb-c8e3dbafa43&title=&width=735)

## Virtual Dom æ¸²æŸ“æµç¨‹

å¾®ä¿¡å¼€å‘è€…å·¥å…·å’Œå¾®ä¿¡å®¢æˆ·ç«¯éƒ½æ— æ³•ç›´æ¥è¿è¡Œå°ç¨‹åºçš„æºç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹å°ç¨‹åºçš„æºç è¿›è¡Œç¼–è¯‘ã€‚  
ä»£ç ç¼–è¯‘è¿‡ç¨‹åŒ…æ‹¬æœ¬åœ°é¢„å¤„ç†ã€æœ¬åœ°ç¼–è¯‘å’ŒæœåŠ¡å™¨ç¼–è¯‘ã€‚  
ä¸ºäº†å¿«é€Ÿé¢„è§ˆï¼Œå¾®ä¿¡å¼€å‘è€…å·¥å…·æ¨¡æ‹Ÿå™¨è¿è¡Œçš„ä»£ç åªç»è¿‡æœ¬åœ°é¢„å¤„ç†ã€æœ¬åœ°ç¼–è¯‘ï¼Œæ²¡æœ‰æœåŠ¡å™¨ç¼–è¯‘è¿‡ç¨‹ï¼Œè€Œå¾®ä¿¡å®¢æˆ·ç«¯è¿è¡Œçš„ä»£ç æ˜¯é¢å¤–ç»è¿‡æœåŠ¡å™¨ç¼–è¯‘çš„ã€‚

### ç¼–è¯‘

```javascript
<!--index.wxml-->
<view class="container">
  Weixin
  <text style="position:relative;" >æ–‡æœ¬</text>
</view>
<button bindtap="test">æŒ‰é’®</button>
```

å¦‚ä¸Šé¢è¿™æ®µç®€å•çš„ wxml æ–‡ä»¶ï¼Œç»è¿‡ç¼–è¯‘ä¹‹åï¼Œè¢«ç¼–è¯‘æˆäº† 1500 å¤šè¡Œ  
å…¨éƒ¨ä»£ç éƒ½è¢«åŒ…è£¹åœ¨$gwxå‡½æ•°ä¸­ï¼Œç¼–è¯‘åçš„WXMLæ–‡ä»¶ï¼Œä»¥jsçš„å½¢å¼æ’å…¥åˆ°äº†æ¸²æŸ“å±‚çš„<script>æ ‡ç­¾ä¸­  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661933046533-5e2f9dfb-371c-4f07-8c5c-0833374c6cb9.png#clientId=u57875a8e-95f9-4&from=paste&height=638&id=ucad21a36&name=image.png&originHeight=1276&originWidth=1612&originalType=binary&ratio=1&rotation=0&showTitle=false&size=183453&status=done&style=none&taskId=u5aae0cd2-228e-4553-89d5-13cd2bfa10d&title=&width=806)  
ä½†æ˜¯åœ¨è¿™ä¸ªscriptæ ‡ç­¾ä¸­æ’å…¥äº†$gwx å‡½æ•°ä¹‹åå¹¶æ²¡æœ‰ç«‹å³æ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚  
åœ¨æ¸²æŸ“å±‚çš„ä¸€ä¸ªçš„<script>æ ‡ç­¾ä¸­,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ®µä»£ç 

```javascript
var decodeName = decodeURI("./pages/index/index.wxml");
var generateFunc = $gwx(decodeName);
```

æˆ‘ä»¬åœ¨æ§åˆ¶æŠ¬æ‰‹åŠ¨æ‰§è¡Œ$gwx()çš„è¿”å›å€¼ generateFunc()å‡½æ•°  
è¿”å›çš„æ ‘å½¢ç»“æ„ï¼Œå°±æ˜¯è¯¥é¡µé¢ wxml å¯¹åº”çš„ js å¯¹è±¡å½¢å¼è¡¨ç¤ºçš„ dom æ ‘  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661934505444-ace4b886-2d53-4acd-b5ce-4a006cd3d946.png#clientId=u57875a8e-95f9-4&from=paste&height=390&id=ub80edb1b&name=image.png&originHeight=780&originWidth=856&originalType=binary&ratio=1&rotation=0&showTitle=false&size=103228&status=done&style=none&taskId=u0441d448-2a87-4db6-b5eb-78c1cd58556&title=&width=428)  
è¿™æ˜¯ä¸€ä¸ªç±»ä¼¼ Virtual Dom çš„å¯¹è±¡ï¼Œäº¤ç»™äº† WAWebview.js æ¥æ¸²æŸ“æˆçœŸå® DOM

## äº‹ä»¶ç³»ç»Ÿè®¾è®¡

æ ¸å¿ƒåœ¨äºï¼Œwxml å’Œ js æ–‡ä»¶åœ¨ä¸¤ä¸ªçº¿ç¨‹æ¸²æŸ“ï¼Œè§£æã€‚äº‹ä»¶å¦‚ä½•ç»‘å®š?  
æˆ‘ä»¬æœ€å¼€å§‹åœ¨ wxml æ–‡ä»¶ä¸­å®šä¹‰çš„äº‹ä»¶ç»‘å®šï¼Œå…¶å®è½¬åŒ–æˆè™šæ‹Ÿ dom æ ‘ç»“æ„ä¹‹åï¼Œå…¶å®åªæ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œè¡¨æ˜äº†æŸä¸ª dom ä¸Šæœ‰ç»‘å®šæŸä¸ªäº‹ä»¶ï¼Œå¹¶æ²¡æœ‰å®Œæˆäº‹ä»¶ç»‘å®šã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661853475621-0f781a3d-81d0-4423-8bb1-14d7e03d1786.png#clientId=u8eecab90-4676-4&from=paste&height=383&id=uca370680&name=image.png&originHeight=505&originWidth=851&originalType=binary&ratio=1&rotation=0&showTitle=false&size=124183&status=done&style=none&taskId=u3d677ce9-3e3b-445e-bc23-3a6dde8267e&title=&width=645.5)  
WAWebview.js å¤„ç†è™šæ‹Ÿ dom æ ‘æ—¶ï¼Œä¼šå»å¾ªç¯éå† attr å±æ€§ï¼Œåˆ¤æ–­ attr ä¸­çš„å±æ€§åæ˜¯å¦ä¸ºäº‹ä»¶å±æ€§  
if (n = e.match(/^(capture-)?(mut-)?(bind|catch):?(.+)$/))  
å¦‚æœæ˜¯ï¼Œé€šè¿‡ addListener æ–¹æ³•è¿›è¡Œäº†äº‹ä»¶ç»‘å®šã€‚  
å¯ä»¥ç†è§£æˆï¼Œé€šè¿‡ addListner æ–¹æ³•ç›‘å¬ tap äº‹ä»¶ï¼Œå°±ç›¸å½“äº window.addEventListener å¯¹ mouseup æ–¹æ³•çš„ç›‘å¬ã€‚  
å›è°ƒå‡½æ•°ä¸­å¯¹å‡½æ•°çš„ event ä¿¡æ¯è¿›è¡Œç»„è£…ï¼Œå¹¶è§¦å‘ sendData æ–¹æ³•ã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661930291700-5f910118-028c-44da-81da-f45f2a0b90e4.png#clientId=u57875a8e-95f9-4&from=paste&height=184&id=u59b6c9e0&name=image.png&originHeight=367&originWidth=1263&originalType=binary&ratio=1&rotation=0&showTitle=false&size=216616&status=done&style=none&taskId=u407e8784-4e22-435a-9093-a43ef27337f&title=&width=631.5)  
sendData æ–¹æ³•å°±æ˜¯å‘é€»è¾‘çº¿ç¨‹å‘é€ event æ•°æ®çš„æ–¹æ³•ã€‚  
ä¸‹å›¾æ˜¯æˆ‘ä»¬åœ¨é€»è¾‘å±‚æ¥æ”¶åˆ°çš„æ•°æ®å’Œå‡†å¤‡å‘é€çš„æ•°æ®ç»“æ„  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661930159318-2636bad7-a9fe-4014-8259-65edd5018e8e.png#clientId=u57875a8e-95f9-4&from=paste&height=192&id=u1e5938de&name=image.png&originHeight=384&originWidth=1184&originalType=binary&ratio=1&rotation=0&showTitle=false&size=88750&status=done&style=none&taskId=u6de27a9a-5110-472a-9866-5f8f0edb421&title=&width=592)  
å¯ä»¥çœ‹åˆ°æ•°æ®ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œ  
**ç›®å‰åœ¨è§¦å‘ sendData æ–¹æ³•ä¹‹å‰è¿™äº›é€»è¾‘çš„è§£æåŒ…æ‹¬ event å‚æ•°çš„ç»„è£…éƒ½æ˜¯åœ¨æ¸²æŸ“å±‚çš„åº•å±‚åŸºç¡€åº“ WAWebview.js ä¸­å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜åœ¨æ¸²æŸ“çº¿ç¨‹ä¸­ã€‚**

### äº‹ä»¶

**å¾®ä¿¡å°ç¨‹åºä¸­ä¸»è¦äº‹ä»¶ç»‘å®š:bind catch **  
bind /catch åå¯ä»¥ç´§è·Ÿä¸€ä¸ªå†’å·ï¼Œå…¶å«ä¹‰ä¸å˜ï¼Œå¦‚ bind:tap catch:tapã€‚  
catch ä¼šé˜»æ­¢äº‹ä»¶å‘ä¸Šå†’æ³¡ã€‚  
mut-bind æ¥ç»‘å®šäº‹ä»¶ã€‚ä¸€ä¸ª mut-bind è§¦å‘åï¼Œå¦‚æœäº‹ä»¶å†’æ³¡åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šï¼Œå…¶ä»–èŠ‚ç‚¹ä¸Šçš„ mut-bind ç»‘å®šå‡½æ•°ä¸ä¼šè¢«è§¦å‘ï¼Œä½† bind ç»‘å®šå‡½æ•°å’Œ catch ç»‘å®šå‡½æ•°ä¾æ—§ä¼šè¢«è§¦å‘ã€‚  
éœ€è¦åœ¨æ•è·é˜¶æ®µç›‘å¬äº‹ä»¶æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ capture-bindã€capture-catch å…³é”®å­—ï¼Œåè€…å°†ä¸­æ–­æ•è·é˜¶æ®µå’Œå–æ¶ˆå†’æ³¡é˜¶æ®µã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662020503323-ca3b89fb-a26a-4ff2-9908-906cef7326a7.png#clientId=ue2bed55b-8fb0-4&from=paste&height=470&id=ubd8259da&name=image.png&originHeight=940&originWidth=1178&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38311&status=done&style=none&taskId=ud0166861-849f-48f2-b34e-502b78ee25d&title=&width=589)

## é€šè®¯ç³»ç»Ÿè®¾è®¡

æœ€ä¸Šé¢æåˆ°ï¼Œè§†å›¾å±‚å’Œé€»è¾‘å±‚é€šè®¯æ˜¯é€šè¿‡ Native å±‚ã€‚  
å…·ä½“çš„æ‰‹æ®µå°±æ˜¯

- ios åˆ©ç”¨ WKWebView çš„æä¾› messageHandlers ç‰¹æ€§
- android æ˜¯å¾€ webview çš„ window å¯¹è±¡æ³¨å…¥ä¸€ä¸ªåŸç”Ÿæ–¹æ³•

è¿™ä¸¤ç§ä¼šç»Ÿä¸€å°è£…æˆ weixinJSBridgeï¼Œè¿™å’Œæ­£å¸¸ h5 ä¸å®¢æˆ·ç«¯é€šè®¯æ‰‹æ®µä¸€è‡´  
åˆå§‹åŒ–è¿‡ç¨‹ä¸­ Native å±‚ç†è®ºä¸Šæ˜¯å¾®ä¿¡å®¢æˆ·ç«¯ï¼Œåˆ†åˆ«åœ¨è§†å›¾å±‚å’Œä¸šåŠ¡é€»è¾‘å±‚æ³¨å…¥äº† WeixinJSBridge  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661852352119-4f9a285f-46f5-4848-a97d-e9e8c4d4e140.png#clientId=u8eecab90-4676-4&from=paste&height=243&id=bSROK&name=image.png&originHeight=486&originWidth=1846&originalType=binary&ratio=1&rotation=0&showTitle=false&size=169989&status=done&style=none&taskId=u8afa72f5-4cc5-4ae3-ad01-1276096e9d7&title=&width=923)

## ç”Ÿå‘½å‘¨æœŸè®¾è®¡

### data

é€»è¾‘å±‚çš„ data ä¸ view æ˜¯ç›¸äº’ç»‘å®šçš„ï¼Œdata æ˜¯é¡µé¢ç¬¬ä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨çš„åˆå§‹æ•°æ®ã€‚é¡µé¢åŠ è½½çš„æ—¶å€™ï¼Œdata å°†ä¼šä»¥ JSON å­—ç¬¦ä¸²å½¢å¼ç”±é€»è¾‘å±‚ä¼ è‡³æ¸²æŸ“å±‚ã€‚å› æ­¤ data ä¸­çš„æ•°æ®å¿…é¡»æ˜¯å¯ä»¥è½¬æˆ JSON çš„ç±»å‹ï¼šå­—ç¬¦ä¸²ï¼Œæ•°å­—ï¼Œå¸ƒå°”å€¼ï¼Œå¯¹è±¡ï¼Œæ•°ç»„ã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661931055643-bd20dbe2-82ee-4cdd-9591-eb625dbea1e8.png#clientId=u57875a8e-95f9-4&from=paste&height=442&id=u349fac4f&name=image.png&originHeight=368&originWidth=493&originalType=binary&ratio=1&rotation=0&showTitle=false&size=89956&status=done&style=none&taskId=ue8532b65-1025-4008-86a8-6df0970acb5&title=&width=591.5)  
å›¾ä¸­ï¼Œæ¸²æŸ“å±‚å’Œé€»è¾‘å±‚éƒ½ä» start å¼€å§‹å‡ºå‘ï¼Œè‡ªèº«åˆ†åˆ«è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œéƒ½åˆå§‹åŒ–å®Œæ¯•åè¦æ€ä¹ˆåšå‘¢ï¼Ÿä¸¤æ¡çº¿ç¨‹äº’ç›¸å¹¶ä¸çŸ¥é“å¯¹æ–¹åˆå§‹åŒ–æ€ä¹ˆæ ·äº†ã€‚  
æ‰€ä»¥è¿™ä¸ªæ—¶å€™ç”±æ¸²æŸ“å±‚å‘å‡ºä¿¡å·ï¼Œå‘å‡ºä¸€ä¸ªæˆ‘å·²ç»åˆå§‹åŒ–å®Œæ¯•çš„ä¿¡å·å‘ç»™é€»è¾‘å±‚ï¼Œå¹¶ä¸”è‡ªèº«çŠ¶æ€è¿›å…¥ç­‰å¾…ã€‚  
é€»è¾‘å±‚æ”¶åˆ°è¿™ä¸ªä¿¡å·çš„æ—¶å€™æœ‰ä¸¤ç§æƒ…å†µã€‚

- ç¬¬ä¸€ç§å°±æ˜¯è‡ªèº«è¿˜æ²¡åˆå§‹åŒ–å®Œï¼Œé‚£ä¹ˆæ”¶åˆ°æ­¤ä¿¡å·ååªéœ€è¦åˆå§‹åŒ–å®Œæ¯•åå‘é€åˆå§‹æ•°æ® Data åˆ°æ¸²æŸ“å±‚å³å¯ã€‚
- ç¬¬äºŒç§æƒ…å†µå°±æ˜¯é€»è¾‘å±‚æ—©å·²ç»è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‚£ä¹ˆæ”¶åˆ°ä¿¡å·åç«‹å³å‘é€åˆå§‹æ•°æ® Data åˆ°æ¸²æŸ“å±‚å³å¯ã€‚

### ç”Ÿå‘½å‘¨æœŸ

- onLoad(Object query) é¡µé¢åŠ è½½æ—¶è§¦å‘ï¼Œä¸€ä¸ªé¡µé¢åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œå¯ä»¥åœ¨ onLoad çš„å‚æ•°ä¸­è·å–æ‰“å¼€å½“å‰é¡µé¢è·¯å¾„ä¸­çš„å‚æ•°ã€‚
- onShow() é¡µé¢æ˜¾ç¤º/åˆ‡å…¥å‰å°æ—¶è§¦å‘
- onHide() é¡µé¢éšè—/åˆ‡å…¥åå°æ—¶è§¦å‘ã€‚ å¦‚ wx.navigateTo æˆ–åº•éƒ¨ tab åˆ‡æ¢åˆ°å…¶ä»–é¡µé¢ï¼Œå°ç¨‹åºåˆ‡å…¥åå°ç­‰ã€‚
- onReady() é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆæ—¶è§¦å‘ã€‚ä¸€ä¸ªé¡µé¢åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œä»£è¡¨é¡µé¢å·²ç»å‡†å¤‡å¦¥å½“ï¼Œå¯ä»¥å’Œè§†å›¾å±‚è¿›è¡Œäº¤äº’ã€‚
- onUnload() é¡µé¢å¸è½½æ—¶è§¦å‘ã€‚å¦‚ wx.redirectTo æˆ– wx.navigateBack åˆ°å…¶ä»–é¡µé¢æ—¶ã€‚

**æˆ‘ä»¬ç»“åˆè·¯ç”±è·³è½¬å’Œ webview è®¾è®¡å»ç†è§£**

- wx.navigateTo æ˜¯åˆ›å»ºäº†æ–°çš„ webview,å½“å‰ webview è¿›å…¥ Hide()
- wx.redirectTo ä»¥åŠ wx.navigateBack æ˜¯é€šè¿‡æ›´æ–°è‡ªèº« webview è¿›è¡Œé¡µé¢è½¬æ¢çš„ï¼Œæ‰€ä»¥å½“å‰é¡µé¢ä¼šè¿›è¡Œå¸è½½æ“ä½œï¼Œå¹¶ä¸”é‡æ–°ç”Ÿæˆæ–°é¡µé¢ã€‚æ‰€ä»¥ä¸¤ä¸ªé¡µé¢éƒ½ä¼šè¿›å…¥å®Œæ•´ç”Ÿå‘½å‘¨æœŸåºåˆ—ã€‚

é…åˆæ•´ä½“æ¶æ„å›¾æ¥çœ‹ä¸€ä¸‹ç”Ÿå‘½å‘¨æœŸã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661931322593-b837d6e0-656b-4f4f-a97b-9b4d78e73a6c.png#clientId=u57875a8e-95f9-4&from=paste&height=703&id=u03ba196e&name=image.png&originHeight=777&originWidth=777&originalType=binary&ratio=1&rotation=0&showTitle=false&size=284728&status=done&style=none&taskId=ubd3062be-9727-4935-a6b7-dbb9fbceb45&title=&width=702.5)

## è·¯ç”±è®¾è®¡

### è·¯ç”±æ ˆ

å°ç¨‹åºä¸­ä¸åƒå•é¡µé¢åº”ç”¨ï¼Œé‡‡ç”¨å¤šä¸ª webview ç±»ä¼¼å¤šé¡µã€‚  
è§¦å‘è·¯ç”±çš„è¡Œä¸ºå¯ä»¥æ˜¯é€»è¾‘å±‚è§¦å‘ï¼Œä¹Ÿå¯ä»¥ä»è§†å›¾å±‚è§¦å‘ã€‚åœ¨è§†å›¾å±‚ä¸­ç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»å›é€€æŒ‰é’®ï¼Œæˆ–è€…å›é€€ä¸Šä¸€é¡µçš„æ‰‹åŠ¿ç­‰æœºåˆ¶è§¦å‘ã€‚åœ¨é€»è¾‘å±‚ä¸­å‘å‡ºçš„ä¿¡å·æœ‰æ‰“å¼€æ–°é¡µé¢ navigateToã€é‡å®šå‘ redirectToã€é¡µé¢è¿”å› navigateBack ç­‰ï¼Œå¼€å‘è€…é€šè¿‡å®˜ç½‘æä¾›çš„ API è§¦å‘ã€‚  
æ— è®ºé€»è¾‘å±‚è¿˜æ˜¯è§†å›¾å±‚ï¼Œè¿™ä¸ªè¡Œä¸ºéƒ½ä¼šè¢«å‘é€åˆ° Native å±‚ï¼Œæœ‰ Native å±‚ç»Ÿä¸€æ§åˆ¶è·¯ç”±ã€‚å¯¹äº webview çš„æ·»åŠ æˆ–åˆ é™¤éƒ½ä¼šæœ‰ä¸€ä¸ªè½½ä½“æ¥ç»´æŠ¤ï¼Œè¿™å°±æ˜¯è·¯ç”±æ ˆã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661932072495-d5125c5c-8f4b-465a-903a-c9ba9c035d21.png#clientId=u57875a8e-95f9-4&from=paste&height=480&id=u366815e2&name=image.png&originHeight=650&originWidth=966&originalType=binary&ratio=1&rotation=0&showTitle=false&size=183845&status=done&style=none&taskId=u90d18e4b-f078-43b3-9563-98b992374cb&title=&width=713)  
ä¸Šå›¾ä¸­ï¼Œé€»è¾‘å±‚ä¸­å‘å‡ºæ‰“å¼€é¡µé¢è¡Œä¸ºåˆ° Native å±‚ï¼ŒNative å±‚æ”¶åˆ°è¡Œä¸ºåé€šè¿‡ pageFrame å¿«é€Ÿåˆ›å»º webviewï¼Œå¹¶ä¸”æ¨å…¥è·¯ç”±æ ˆã€‚é¡µé¢åˆ›å»ºå®Œåï¼Œåº•å±‚åŸºç¡€åº“ä¼šç«‹åˆ»æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œåˆå§‹åŒ–å®Œæ¯•åä¼šå‘é€ä¸€ä¸ªä¿¡å·é€šçŸ¥ Native é¡µé¢å·²ç»åˆ›å»ºå¹¶åˆå§‹åŒ–å®Œæ¯•ï¼Œéšå Native å±‚å‘é€ä¿¡å·åˆ°é€»è¾‘å±‚ä¸­ã€‚  
é€šçŸ¥çš„ç›®çš„æœ‰ä¸¤ä¸ªï¼š  
éœ€è¦é€šçŸ¥å¼€å‘è€…é¡µé¢å·²ç»åˆ›å»ºæˆåŠŸã€‚  
åœ¨æ²™ç®±ä¸­åˆ›å»ºæ–°é¡µé¢çš„â€œæ ¹ç»„ä»¶â€ï¼Œå¹¶æ­£å¼å¼€å¯æ–°é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸä¸æ¸²æŸ“çš„æµç¨‹ã€‚

## æ€§èƒ½ä¼˜åŒ–

ç¨‹åºçš„æ€§èƒ½åˆå¯ä»¥åˆ†ä¸ºã€Œ[å¯åŠ¨æ€§èƒ½](https://developers.weixin.qq.com/miniprogram/dev/framework/performance/tips/start)ã€å’Œã€Œ[è¿è¡Œæ—¶æ€§èƒ½](https://developers.weixin.qq.com/miniprogram/dev/framework/performance/tips)ã€ä¸¤ä¸ªä¸»é¢˜ã€‚ã€Œå¯åŠ¨æ€§èƒ½ã€è®©ç”¨æˆ·èƒ½å¤Ÿæ›´å¿«çš„æ‰“å¼€å¹¶çœ‹åˆ°å°ç¨‹åºçš„å†…å®¹ï¼Œã€Œè¿è¡Œæ—¶æ€§èƒ½ã€ä¿éšœç”¨æˆ·èƒ½å¤Ÿæµç•…çš„ä½¿ç”¨å°ç¨‹åºçš„åŠŸèƒ½ã€‚

### å°ç¨‹åºå¯åŠ¨æµç¨‹

#### 1.èµ„æºå‡†å¤‡

##### 1.1 å°ç¨‹åºç›¸å…³ä¿¡æ¯å‡†å¤‡

å¾®ä¿¡å®¢æˆ·ç«¯éœ€è¦ä»å¾®ä¿¡åå°è·å–å°ç¨‹åºçš„**å¤´åƒã€æ˜µç§°ã€ç‰ˆæœ¬ã€é…ç½®ã€æƒé™**ç­‰åŸºæœ¬ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¼šåœ¨æœ¬åœ°ç¼“å­˜ï¼Œå¹¶é€šè¿‡ä¸€å®šçš„æœºåˆ¶è¿›è¡Œæ›´æ–°ã€‚

##### 1.1 ç¯å¢ƒé¢„åŠ è½½

ä¸ºäº†å°½å¯èƒ½çš„é™ä½è¿è¡Œç¯å¢ƒå‡†å¤‡å¯¹å¯åŠ¨è€—æ—¶çš„å½±å“ï¼Œå¾®ä¿¡å®¢æˆ·ç«¯ä¼šæ ¹æ®ç”¨æˆ·çš„ä½¿ç”¨åœºæ™¯å’Œè®¾å¤‡èµ„æºçš„ä½¿ç”¨æƒ…å†µï¼Œä¾ç…§ä¸€å®šç­–ç•¥åœ¨å°ç¨‹åº**å¯åŠ¨å‰**å¯¹è¿è¡Œç¯å¢ƒè¿›è¡Œéƒ¨åˆ†åœ°**é¢„åŠ è½½**ï¼Œä»¥é™ä½å¯åŠ¨è€—æ—¶ã€‚  
**ä½†ä¸ä¸€å®šå‘½ä¸­**  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662022380424-c6863b77-fbc1-49b2-b876-f8f7d4cbd9cd.png#clientId=ue2bed55b-8fb0-4&from=paste&height=374&id=ubc1d6113&name=image.png&originHeight=281&originWidth=531&originalType=binary&ratio=1&rotation=0&showTitle=false&size=34200&status=done&style=none&taskId=u8da5f0eb-0c72-4e1d-92f2-469f2259563&title=&width=707.5)

##### 1.2 ä»£ç åŒ…å‡†å¤‡

ä»å¾®ä¿¡åå°è·å–ä»£ç åŒ…åœ°å€ï¼Œä» CDN ä¸‹è½½å°ç¨‹åºä»£ç åŒ…  
å°ç¨‹åºä»£ç åŒ…ä¼šåœ¨æœ¬åœ°ç¼“å­˜ï¼Œå¹¶é€šè¿‡[æ›´æ–°æœºåˆ¶](https://developers.weixin.qq.com/miniprogram/dev/framework/runtime/update-mechanism.html)è¿›è¡Œæ›´æ–°ã€‚  
åŒæ­¥ä¸‹è½½/å¼‚æ­¥ä¸‹è½½ å¼ºåˆ¶æ›´æ–°/é™é»˜æ›´æ–°  
ä¸ºä¾‹é™ä½ä»£ç åŒ…ä¸‹è½½çš„è€—æ—¶ï¼Œå¾®ä¿¡åšçš„ä¸€äº›ä¼˜åŒ–

- ä»£ç åŒ…å‹ç¼©
- å¢é‡æ›´æ–°
- ä¼˜å…ˆä½¿ç”¨ QUIC å’Œ HTTP/2
- é¢„å…ˆå»ºç«‹è¿æ¥ï¼šåœ¨ä¸‹è½½å‘ç”Ÿå‰ï¼Œæå‰å’Œ CDN å»ºç«‹è¿æ¥ï¼Œé™ä½ä¸‹è½½è¿‡ç¨‹ä¸­ DNS è¯·æ±‚å’Œè¿æ¥å»ºç«‹çš„è€—æ—¶
- ä»£ç åŒ…å¤ç”¨ï¼šå¯¹æ¯ä¸ªä»£ç åŒ…éƒ½ä¼šè®¡ç®— MD5 ç­¾åã€‚å³ä½¿å‘ç”Ÿäº†ç‰ˆæœ¬æ›´æ–°ï¼Œå¦‚æœä»£ç åŒ…çš„ MD5 æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¸éœ€è¦é‡æ–°è¿›è¡Œä¸‹è½½ã€‚

#### 2.ä»£ç æ³¨å…¥

å°ç¨‹åºå¯åŠ¨æ—¶éœ€è¦ä»ä»£ç åŒ…å†…è¯»å–å°ç¨‹åºçš„é…ç½®å’Œä»£ç ï¼Œå¹¶æ³¨å…¥åˆ° JavaScript å¼•æ“ä¸­ã€‚  
å¾®ä¿¡å®¢æˆ·ç«¯ä¼šä½¿ç”¨ V8 å¼•æ“çš„ [Code Caching](https://v8.dev/blog/code-caching-for-devs) æŠ€æœ¯å¯¹ä»£ç ç¼–è¯‘ç»“æœè¿›è¡Œç¼“å­˜ï¼Œé™ä½éé¦–æ¬¡æ³¨å…¥æ—¶çš„ç¼–è¯‘è€—æ—¶

> code cache

> V8 ä¼šæŠŠç¼–è¯‘å’Œè§£æçš„ç»“æœç¼“å­˜ä¸‹æ¥ï¼Œç­‰åˆ°ä¸‹æ¬¡é‡åˆ°ç›¸åŒçš„æ–‡ä»¶ï¼Œç›´æ¥è·³è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼ŒæŠŠç›´æ¥ç¼“å­˜å¥½çš„æ•°æ®æ‹¿æ¥ä½¿ç”¨

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662043511251-a1eb3e38-2d11-4c55-bacf-be7c3c85b0e1.png#clientId=u5b5ecdc4-d4b3-4&from=paste&height=1214&id=u2e62bb3a&name=image.png&originHeight=1042&originWidth=489&originalType=binary&ratio=1&rotation=0&showTitle=false&size=70375&status=done&style=none&taskId=u0192c173-ce2f-4d53-8e10-ef0928aa368&title=&width=569.5)

### å¯åŠ¨æ—¶æ€§èƒ½ä¼˜åŒ–

#### æ§åˆ¶ä»£ç åŒ…ä½“ç§¯

- æ¨èæ‰€æœ‰å°ç¨‹åºä½¿ç”¨åˆ†åŒ…åŠ è½½
- é¿å…éå¿…è¦ä½¿ç”¨å…¨å±€è‡ªå®šä¹‰ç»„ä»¶å’Œæ’ä»¶
  - ä¼šå½±å“æŒ‰éœ€æ³¨å…¥çš„æ•ˆæœå’Œå°ç¨‹åºä»£ç æ³¨å…¥çš„è€—æ—¶
- æ§åˆ¶èµ„æºæ–‡ä»¶
  - å»ºè®®å¼€å‘è€…åœ¨ä»£ç åŒ…å†…çš„å›¾ç‰‡ä¸€èˆ¬åº”åªåŒ…å«ä¸€äº›ä½“ç§¯è¾ƒå°çš„å›¾æ ‡ï¼Œé¿å…åœ¨ä»£ç åŒ…ä¸­åŒ…å«æˆ–åœ¨ WXSS ä¸­ä½¿ç”¨ base64 å†…è”è¿‡å¤šã€è¿‡å¤§çš„å›¾ç‰‡ç­‰èµ„æºæ–‡ä»¶ã€‚
  - è¿™ç±»æ–‡ä»¶åº”å°½å¯èƒ½éƒ¨ç½²åˆ° CDNï¼Œå¹¶ä½¿ç”¨ URL å¼•å…¥ã€‚

#### ä»£ç æ³¨å…¥ä¼˜åŒ–

- æ¨èæ‰€æœ‰å°ç¨‹åºä½¿ç”¨æŒ‰éœ€æ³¨å…¥
- ç”¨æ—¶æ³¨å…¥
  - ä¸ºè‡ªå®šä¹‰ç»„ä»¶é…ç½® [å ä½ç»„ä»¶](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/placeholder.html)ï¼Œç»„ä»¶å°±ä¼šè‡ªåŠ¨è¢«è§†ä¸ºç”¨æ—¶æ³¨å…¥ç»„ä»¶
- å¯åŠ¨è¿‡ç¨‹ä¸­å‡å°‘åŒæ­¥ API çš„è°ƒç”¨
  - å»ºè®®ä¼˜å…ˆä½¿ç”¨æ‹†åˆ†åçš„ getSystemSetting/getAppAuthorizeSetting/getDeviceInfo/getWindowInfo/getAppBaseInfo æŒ‰éœ€è·å–ä¿¡æ¯ï¼Œæˆ–ä½¿ç”¨ä½¿ç”¨å¼‚æ­¥ç‰ˆæœ¬ [getSystemInfoAsync](https://developers.weixin.qq.com/miniprogram/dev/api/base/system/wx.getSystemInfoAsync.html)
  - getStorageSync/setStorageSync åº”åªç”¨æ¥è¿›è¡Œæ•°æ®çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œä¸åº”ç”¨äºè¿è¡Œæ—¶çš„æ•°æ®ä¼ é€’æˆ–å…¨å±€çŠ¶æ€ç®¡ç†ã€‚

#### é¦–å±æ¸²æŸ“ä¼˜åŒ–

- å¯ç”¨ã€Œ[åˆå§‹æ¸²æŸ“ç¼“å­˜](https://developers.weixin.qq.com/miniprogram/dev/framework/view/initial-rendering-cache.html)ã€
  - å¯ç”¨åˆå§‹æ¸²æŸ“ç¼“å­˜ï¼Œå¯ä»¥ä½¿è§†å›¾å±‚ä¸éœ€è¦ç­‰å¾…é€»è¾‘å±‚åˆå§‹åŒ–å®Œæ¯•ï¼Œè€Œç›´æ¥æå‰å°†é¡µé¢åˆå§‹ data çš„æ¸²æŸ“ç»“æœå±•ç¤ºç»™ç”¨æˆ·ï¼Œè¿™å¯ä»¥ä½¿å¾—é¡µé¢å¯¹ç”¨æˆ·å¯è§çš„æ—¶é—´å¤§å¤§æå‰
- æå‰é¦–å±æ•°æ®è¯·æ±‚
  - é¢„æ‹‰å–èƒ½å¤Ÿåœ¨å°ç¨‹åºå†·å¯åŠ¨çš„æ—¶å€™é€šè¿‡å¾®ä¿¡åå°æå‰å‘ç¬¬ä¸‰æ–¹æœåŠ¡å™¨æ‹‰å–ä¸šåŠ¡æ•°æ®ï¼Œå½“ä»£ç åŒ…åŠ è½½å®Œæ—¶å¯ä»¥æ›´å¿«åœ°æ¸²æŸ“é¡µé¢ï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ï¼Œä»è€Œæå‡å°ç¨‹åºçš„æ‰“å¼€é€Ÿåº¦
  - å‘¨æœŸæ€§æ›´æ–°èƒ½å¤Ÿåœ¨ç”¨æˆ·æœªæ‰“å¼€å°ç¨‹åºçš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½ä»æœåŠ¡å™¨æå‰æ‹‰å–æ•°æ®ï¼Œå½“ç”¨æˆ·æ‰“å¼€å°ç¨‹åºæ—¶å¯ä»¥æ›´å¿«åœ°æ¸²æŸ“é¡µé¢ï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ï¼Œå¢å¼ºåœ¨å¼±ç½‘æ¡ä»¶ä¸‹çš„å¯ç”¨æ€§ã€‚
- ç¼“å­˜è¯·æ±‚æ•°æ®
- éª¨æ¶å±

### è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–

#### åˆç†ä½¿ç”¨ setData

æ§åˆ¶é¢‘ç‡ï¼ŒèŒƒå›´ï¼Œå†…å®¹

#### é¡µé¢æ¸²æŸ“ä¼˜åŒ–

- é€‚å½“ç›‘å¬ scroll äº‹ä»¶
- æ§åˆ¶ WXML èŠ‚ç‚¹æ•°é‡å’Œå±‚çº§
  - æºç ä¸­ä¸€ä¸ªé¡µé¢ dom æ•°ç›®è¶…è¿‡ 16000ï¼Œè‚¯å®šä¼šæŠ¥é”™
- data å±‚çº§ä¸è¦è¿‡æ·±ï¼Œå› ä¸ºéœ€è¦æ·±åº¦éå†
- ä½¿ç”¨ IntersectionObserver ç›‘å¬å…ƒç´ æ›å…‰

#### é¡µé¢åˆ‡æ¢ä¼˜åŒ–

- é¿å…åœ¨ onHide/onUnload æ‰§è¡Œè€—æ—¶æ“ä½œ
  - é¡µé¢åˆ‡æ¢æ—¶ï¼Œä¼šå…ˆè°ƒç”¨å‰ä¸€ä¸ªé¡µé¢çš„ onHide æˆ– onUnload ç”Ÿå‘½å‘¨æœŸï¼Œç„¶åå†è¿›è¡Œæ–°é¡µé¢çš„åˆ›å»ºå’Œæ¸²æŸ“
- æå‰å‘èµ·æ•°æ®è¯·æ±‚
  - è¿›è¡Œé¡µé¢è·³è½¬æ—¶ï¼ˆä¾‹å¦‚ wx.navigateToï¼‰ï¼Œå¯ä»¥æå‰ä¸ºä¸‹ä¸€ä¸ªé¡µé¢åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚é¡µé¢ä¹‹é—´å¯ä»¥é€šè¿‡ [EventChannel](https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#%E9%A1%B5%E9%9D%A2%E9%97%B4%E9%80%9A%E4%BF%A1) è¿›è¡Œé€šä¿¡ã€‚ç±»ä¼¼ postMessage
  - ä¾‹å¦‚ï¼Œåœ¨é¡µé¢è·³è½¬æ—¶ï¼Œå¯ä»¥åŒæ—¶å‘èµ·ä¸‹ä¸€ä¸ªé¡µé¢çš„æ•°æ®è¯·æ±‚ï¼Œè€Œä¸éœ€è¦ç­‰åˆ°é¡µé¢ onLoad æ—¶å†è¿›è¡Œï¼Œä»è€Œå¯ä»¥è®©ç”¨æˆ·æ›´æ—©çš„çœ‹åˆ°é¡µé¢å†…å®¹ã€‚
- æ§åˆ¶é¢„åŠ è½½ä¸‹ä¸ªé¡µé¢çš„æ—¶æœº
  - ç¨‹åºé¡µé¢åŠ è½½å®Œæˆåï¼Œä¼šé¢„åŠ è½½ä¸‹ä¸€ä¸ªé¡µé¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå°ç¨‹åºæ¡†æ¶ä¼šåœ¨å½“å‰é¡µé¢ onReady è§¦å‘ 200ms åè§¦å‘é¢„åŠ è½½ã€‚
  - é¢„åŠ è½½ä¼šé˜»å¡å½“å‰é¡µé¢ setDataï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å•ä¸ªé¡µé¢çš„é…ç½®å¢åŠ ï¼Œ handleWebviewPreload é€‰é¡¹ï¼Œæ¥æ§åˆ¶é¢„åŠ è½½ä¸‹ä¸ªé¡µé¢çš„æ—¶æœºã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662023993219-421de8d7-07c6-4043-897a-36c260283727.png#clientId=ue2bed55b-8fb0-4&from=paste&height=489&id=uf9834d1a&name=image.png&originHeight=471&originWidth=726&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54155&status=done&style=none&taskId=u175dde48-53b0-4296-a4d0-5698335d19a&title=&width=753)

#### èµ„æºåŠ è½½ä¼˜åŒ–

æ§åˆ¶å›¾ç‰‡å¤§å°

#### å†…å­˜ä¼˜åŒ–

- åˆç†åˆ†åŒ…ï¼Œæ—¢èƒ½å‡å°‘è€—æ—¶ï¼Œä¹Ÿèƒ½é™ä½å†…å­˜å ç”¨
- äº‹ä»¶ç›‘å¬ï¼Œå®šæ—¶å™¨è®°å¾—æ¸…é™¤

## ä¸‰æ–¹åº“æ¡†æ¶è®¾è®¡

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662079285359-94e875fb-aa87-4a62-b11c-fdc18860bac7.png#clientId=uaf042545-508f-4&from=paste&height=288&id=uc40b1a95&name=image.png&originHeight=575&originWidth=1500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=361085&status=done&style=none&taskId=u27306ea9-49c3-40de-8985-b9c9f432c92&title=&width=750)  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661760136526-11a9a6f5-e909-431f-acd0-91d7eabcded3.png#clientId=u6a11aa1d-fb4c-4&from=paste&height=117&id=u1b12c59a&name=image.png&originHeight=234&originWidth=1128&originalType=binary&ratio=1&rotation=0&showTitle=false&size=51672&status=done&style=none&taskId=u95194b0b-1661-4aa9-96ca-e9e186fb7b5&title=&width=564)![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1661760737465-43d9d81a-6e23-435a-bc35-bf8aaef29b33.png#clientId=u6a11aa1d-fb4c-4&from=paste&height=254&id=u0c106193&name=image.png&originHeight=508&originWidth=1144&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145397&status=done&style=none&taskId=u22017952-9abe-4c75-a4b9-9c8954526b1&title=&width=572)

## å°ç¨‹åºä¸ºä»€ä¹ˆå¿«ï¼ˆä¸æ™®é€š h5 ç›¸æ¯”ï¼‰

> æˆ‘ä»¬åœ¨å¯¹å°ç¨‹åºçš„æ¶æ„è®¾è®¡æ—¶çš„è¦æ±‚åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯è¦å¿«ï¼ŒåŒ…æ‹¬è¦æ¸²æŸ“å¿«ã€åŠ è½½å¿«ç­‰ã€‚å½“ç”¨æˆ·ç‚¹å¼€æŸä¸ªå°ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬æœŸæœ›ä½“éªŒåˆ°çš„æ˜¯åªæœ‰å¾ˆçŸ­æš‚çš„åŠ è½½ç•Œé¢ï¼Œåœ¨ä¸€ä¸ªè¿‡æ¸¡åŠ¨ç”»ä¹‹åå¯ä»¥é©¬ä¸Šçœ‹åˆ°å°ç¨‹åºçš„ä¸»ç•Œé¢ã€‚

- åŒçº¿ç¨‹ï¼Œæ¸²æŸ“å±‚å’Œé€»è¾‘å±‚å¹¶è¡Œä¸é˜»å¡
- å¤šä¸ª webviewï¼Œé¡µé¢åˆ‡æ¢æ›´æµç•…
- webview é¢„åŠ è½½
- å®‰è£…åŒ…ç¼“å­˜
- ä»¥åŠå¾®ä¿¡åšäº†å¤§é‡çš„ä¼˜åŒ–å’Œçœ‹ä¸è§çš„æ“ä½œ

## æ€»ç»“ä¸å±•æœ›

- å°ç¨‹åºæ‹¥æœ‰æ¥è¿‘åŸç”Ÿ App çš„ä½“éªŒã€‚
- å°ç¨‹åºå¹¶ä¸æ˜¯çœŸæ­£çš„ â€œæ— éœ€ä¸‹è½½â€ï¼Œåªæ˜¯å°ç¨‹åºçš„ä½“ç§¯å¾ˆå°ï¼Œåœ¨å½“ä»Šé«˜é€Ÿçš„ç½‘ç»œç¯å¢ƒä¸‹èƒ½å¤Ÿå¿«é€Ÿä¸‹è½½ï¼Œç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°ï¼Œæ›´ç¡®åˆ‡çš„æ¥è¯´æ˜¯ â€œæ— æ„Ÿä¸‹è½½â€ã€‚
- åŸºäºç§»åŠ¨ç«¯å¸ƒå±€çš„å±€é™æ€§ï¼Œå¯ä»¥é«˜æ•ˆä¸”ç®€å•çš„å¼€å‘ï¼Œè¿­ä»£å¿«é€Ÿã€‚
- å°ç¨‹åºæ˜¯åŒçº¿ç¨‹æ¨¡å‹ï¼Œé€»è¾‘å±‚å’Œæ¸²æŸ“å±‚åˆ†åˆ«è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œé€šè¿‡ JSBridge è¿›è¡Œé€šä¿¡ã€‚

ç°åœ¨å·²çŸ¥çš„å°ç¨‹åºæœ‰ å¾®ä¿¡ï¼Œæ”¯ä»˜å®ï¼ŒæŠ–éŸ³ï¼Œqqï¼Œè™ç‰™ï¼Œæ–—é±¼ï¼Œé¥¿äº†ä¹ˆï¼Œç™¾åº¦ï¼Œäº¬ä¸œç­‰ç­‰  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662045461421-e802ece3-65fd-4e6f-b447-2d80363dca8e.png#clientId=u5b5ecdc4-d4b3-4&from=paste&height=324&id=uf734fe78&name=image.png&originHeight=647&originWidth=906&originalType=binary&ratio=1&rotation=0&showTitle=false&size=303942&status=done&style=none&taskId=uf8755ab9-1354-4840-ade0-9fbf4dea143&title=&width=453)  
å·²çŸ¥çš„è¿™äº›éƒ½æ˜¯è¶…çº§ appï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œä¸€èˆ¬æ‰‹æœºåªæŒ‰ç…§å¸¸ç”¨å’Œå¿…è¦çš„ appï¼Œå¯¹äºä¸€èˆ¬çš„ app å…¶å®å¾ˆéš¾æ¨å¹¿ã€‚å¼€å‘ h5 åˆå¤©ç”Ÿéœ€è¦å€ŸåŠ©å¹³å°ç»™äºˆæµé‡ï¼Œä½“éªŒæ— è®ºæ€ä¹ˆä¼˜åŒ–ï¼Œä»æ—§æ¯”ä¸ä¸ŠåŸç”Ÿã€‚ä½†æ˜¯å°ç¨‹åºåœ¨å¯ä»¥å€ŸåŠ©å¹³å°æµé‡çš„åŒæ—¶ï¼Œæœ‰è¾ƒå¥½çš„ç”¨æˆ·ä½“éªŒã€‚  
ç›®å‰å·²ç»å‡ºäº†ä¸‰æ–¹æ¡†æ¶ï¼ŒFinClip æŠŠå°ç¨‹åºæ¬è¿› appã€‚  
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1572912/1662045743419-f412c6c8-3d0c-4432-a006-d949cd2cc7d6.png#clientId=u5b5ecdc4-d4b3-4&from=paste&height=578&id=u831bfa68&name=image.png&originHeight=1155&originWidth=1338&originalType=binary&ratio=1&rotation=0&showTitle=false&size=740869&status=done&style=none&taskId=u5051917a-8aa1-44d4-9d51-f477201e777&title=&width=669)

## å‚è€ƒé“¾æ¥

[https://developers.weixin.qq.com/ebook?action=get_post_info&docid=0000286f908988db00866b85f5640a](https://developers.weixin.qq.com/ebook?action=get_post_info&docid=0000286f908988db00866b85f5640a)

##

##

##

<br>
  
> è¯­é›€åœ°å€ https://www.yuque.com/yuqueyonghuyv23kd/xebk9e/nvggz2